<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Agent Archives</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* Light Theme - Luminescence inspired */
        :root {
            --bg-primary: #FFFCF0;
            --bg-secondary: #F2F0E5;
            --bg-tertiary: #E6E4D9;
            --bg-user: #D0E7F5;
            --bg-assistant: #F4F3EF;
            --text-primary: #100F0F;
            --text-secondary: #6F6E69;
            --text-muted: #878580;
            --border-color: #CECDC3;
            --accent: #205EA6;
            --accent-light: #D9E8F5;
            --assistant-accent: #8B7EC8;
            --assistant-light: #E6E4F5;
            --success: #66800B;
            --warning: #AD8301;
            --danger: #D14D41;
            --shadow-sm: 0 1px 2px rgba(16,15,15,0.04);
            --shadow-md: 0 4px 12px rgba(16,15,15,0.08);
            --shadow-lg: 0 8px 24px rgba(16,15,15,0.12);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --transition: all 0.2s ease;
        }

        /* Dark Theme - Flexoki Inspired (Warm, Earthy, Low Contrast) */
        [data-theme="dark"] {
            --bg-primary: #100F0F;
            --bg-secondary: #1C1B1A;
            --bg-tertiary: #282726;
            --bg-user: #24423A;
            --bg-assistant: #1C1B1A;
            --text-primary: #CECDC3;
            --text-secondary: #A09F98;
            --text-muted: #878580;
            --border-color: #343331;
            --accent: #3AA99F;
            --accent-light: #24423A;
            --assistant-accent: #8B7EC8;
            --assistant-light: #352F44;
            --success: #879A39;
            --warning: #D0A215;
            --danger: #D14D41;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.4);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.5);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.6);
            --glow-accent: 0 0 20px rgba(58, 169, 159, 0.12);
            --glow-focus: 0 0 0 2px rgba(58, 169, 159, 0.25);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Layout */
        .app {
            display: flex;
            width: 100%;
            height: 100vh;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 380px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-img {
            width: 36px;
            height: 36px;
            object-fit: contain;
        }

        /* Light mode: show dark logo (for light background) */
        .logo-img.logo-dark {
            display: block;
        }
        .logo-img.logo-light {
            display: none;
        }

        /* Dark mode: show light logo (for dark background) */
        [data-theme="dark"] .logo-img.logo-dark {
            display: none;
        }
        [data-theme="dark"] .logo-img.logo-light {
            display: block;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
        }

        /* Agent Selector Dropdown */
        .agent-selector {
            position: relative;
        }

        .agent-selector-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: background 0.15s ease;
        }

        .agent-selector-btn:hover {
            background: var(--bg-tertiary);
        }

        .agent-selector-btn svg {
            width: 14px;
            height: 14px;
            color: var(--text-muted);
            transition: transform 0.2s ease;
        }

        .agent-selector.open .agent-selector-btn svg {
            transform: rotate(180deg);
        }

        .agent-selector-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            min-width: 160px;
            display: none;
        }

        .agent-selector.open .agent-selector-menu {
            display: block;
        }

        .agent-selector-menu button {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 10px 14px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 14px;
            text-align: left;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .agent-selector-menu button:first-child {
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        }

        .agent-selector-menu button:last-child {
            border-radius: 0 0 var(--radius-sm) var(--radius-sm);
        }

        .agent-selector-menu button:hover {
            background: var(--bg-tertiary);
        }

        .agent-selector-menu button.active {
            background: var(--accent-light);
            color: var(--accent);
        }

        .agent-selector-menu button .agent-icon {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
        }

        .agent-selector-menu button .agent-icon.claude {
            background: linear-gradient(135deg, #D97706, #F59E0B);
            color: white;
        }

        .agent-selector-menu button .agent-icon.opencode {
            background: linear-gradient(135deg, #059669, #10B981);
            color: white;
        }

        .stats-summary {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .stats-summary-row {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            line-height: 1.4;
        }

        .stats-summary-row.primary {
            font-weight: 600;
            color: var(--text-primary);
        }

        .stats-summary-row.primary span:not(.stats-icon) {
            color: var(--accent);
            font-variant-numeric: tabular-nums;
        }

        .stats-summary-row.secondary {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .stats-summary-row.tertiary {
            font-size: 11px;
            color: var(--text-muted);
            padding-top: 4px;
            border-top: 1px solid var(--border-color);
            margin-top: 4px;
        }

        .stats-icon {
            flex-shrink: 0;
            width: 16px;
            text-align: center;
        }

        /* View Tabs */
        .view-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            padding: 4px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .view-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .view-tab:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .view-tab.active {
            background: var(--bg-secondary);
            color: var(--accent);
            box-shadow: var(--shadow-sm);
        }

        .view-tab svg {
            width: 16px;
            height: 16px;
        }

        /* Dashboard View */
        .dashboard-view {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--bg-primary);
        }

        .dashboard-view.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-sm);
        }

        .dashboard-card.full-width {
            grid-column: 1 / -1;
        }

        .dashboard-card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dashboard-card-title svg {
            width: 18px;
            height: 18px;
            color: var(--accent);
        }

        .dashboard-stat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .dashboard-stat {
            text-align: center;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .dashboard-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent);
            line-height: 1.2;
        }

        .dashboard-stat:nth-child(2) .dashboard-stat-value {
            color: var(--assistant-accent);
        }

        .dashboard-stat:nth-child(3) .dashboard-stat-value {
            color: var(--success);
        }

        .dashboard-stat:nth-child(4) .dashboard-stat-value {
            color: var(--warning);
        }

        .dashboard-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            text-transform: uppercase;
        }

        .chart-container {
            position: relative;
            height: 280px;
            width: 100%;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .project-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .project-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .project-item:last-child {
            border-bottom: none;
        }

        .project-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .project-item-name {
            font-size: 13px;
            color: var(--text-primary);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .project-item-count {
            font-size: 11px;
            color: var(--text-muted);
        }

        .project-item-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .project-item-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 14px 10px 40px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: var(--bg-tertiary);
            transition: var(--transition);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-secondary);
            box-shadow: var(--glow-focus, 0 0 0 2px rgba(32, 94, 166, 0.2));
        }

        .search-box::before {
            content: '';
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23999'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E") center/contain no-repeat;
        }

        /* Filters */
        .filters {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background: var(--bg-secondary);
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--bg-primary);
        }

        [data-theme="dark"] .filter-btn:hover {
            box-shadow: var(--glow-accent);
            border-color: var(--accent);
        }

        .filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        [data-theme="dark"] .filter-btn.active {
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.4);
        }

        .filter-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Date Filter Dropdown */
        .date-filter {
            position: relative;
        }

        .date-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            padding: 16px;
            z-index: 100;
            display: none;
            min-width: 260px;
        }

        .date-dropdown.show {
            display: block;
        }

        .date-quick-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .date-quick-btn {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 14px;
            background: var(--bg-secondary);
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .date-quick-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .date-quick-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .date-dropdown label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .date-inputs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .date-input-group {
            flex: 1;
        }

        .date-dropdown input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 13px;
        }

        .date-dropdown input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .date-dropdown-actions {
            display: flex;
            gap: 8px;
        }

        .date-dropdown-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .date-dropdown-actions .apply {
            background: var(--accent);
            color: white;
        }

        .date-dropdown-actions .apply:hover {
            background: #1d4ed8;
        }

        .date-dropdown-actions .clear {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .date-dropdown-actions .clear:hover {
            background: var(--border-color);
        }

        /* Session List */
        .session-list {
            flex: 1;
            overflow-y: auto;
        }

        .session-group {
            border-bottom: 1px solid var(--border-color);
        }

        .session-group-header {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .session-item {
            padding: 14px 17px 14px 20px; /* Adjusted padding for border */
            border-bottom: 1px solid var(--border-color);
            border-left: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .session-item:hover {
            background: var(--bg-tertiary);
            border-left-color: var(--text-muted);
        }

        .session-item.active {
            background: var(--accent-light);
            border-left-color: var(--accent);
            z-index: 1;
        }

        [data-theme="dark"] .session-item.active {
            box-shadow: inset 0 0 20px rgba(6, 182, 212, 0.05);
            border-left-color: var(--accent);
        }

        .session-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .session-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .active-badge {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-right: 6px;
            animation: pulse-active 2s infinite;
        }

        @keyframes pulse-active {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        [data-theme="dark"] .active-badge {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
        }

        .session-messages {
            font-size: 11px;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .session-messages.history-badge {
            background: #fef3c7;
            color: #d97706;
        }

        .session-item.history-only {
            border-left: 3px solid #f59e0b;
        }

        .session-preview {
            font-size: 13px;
            color: var(--text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.5;
        }

        .session-project {
            font-size: 11px;
            color: var(--accent);
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0; /* Prevent flex item from overflowing */
            min-height: 0; /* CRITICAL: Allow flex children to shrink and enable proper height calculation */
            width: 100%;
            height: 100%; /* Ensure main takes full height of parent */
            position: relative; /* For absolute positioning of right sidebar */
        }

        .main-header {
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-title-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .main-title {
            font-size: 16px;
            font-weight: 600;
        }

        .edit-title-btn {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            color: var(--text-muted);
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .edit-title-btn:hover {
            color: var(--accent);
            background: var(--accent-light);
        }

        .edit-title-btn svg {
            width: 16px;
            height: 16px;
        }

        .main-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Conversation View */
        #conversationView {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
            position: relative;
        }

        .conversation {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 24px;
            min-height: 0;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
            touch-action: pan-y;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 24px;
            max-width: 85%;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            margin-left: auto;
            align-items: flex-end;
        }

        .message.assistant {
            margin-right: auto;
            align-items: flex-start;
        }

        /* Wider messages on large desktop screens */
        @media (min-width: 1400px) {
            .message {
                max-width: 75%;
            }
        }

        @media (min-width: 1800px) {
            .message {
                max-width: 70%;
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .message.user .message-header {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .message.user .message-avatar {
            background: var(--accent-light);
            color: var(--accent);
        }

        .message.assistant .message-avatar {
            background: var(--assistant-light);
            color: var(--assistant-accent);
        }

        .message-role {
            font-size: 13px;
            font-weight: 600;
        }

        .message.user .message-role {
            color: var(--accent);
        }

        .message.assistant .message-role {
            color: var(--assistant-accent);
        }

        .message-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .msg-copy-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            opacity: 0;
            transition: all 0.15s ease;
            margin-left: auto;
        }

        .message:hover .msg-copy-btn {
            opacity: 1;
        }

        .msg-copy-btn:hover {
            background: var(--bg-tertiary);
            color: var(--accent);
        }

        .msg-copy-btn.copied {
            color: var(--success);
        }

        .message-content {
            padding: 16px;
            border-radius: var(--radius-md);
            font-size: 14px;
            line-height: 1.7;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .message.user .message-content {
            background: var(--accent);
            background: linear-gradient(135deg, var(--accent), #2563eb);
            color: white;
            border: none;
            border-radius: 20px 20px 4px 20px;
            box-shadow: var(--shadow-sm);
        }

        [data-theme="dark"] .message.user .message-content {
            background: linear-gradient(135deg, var(--accent), #0891b2);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.25);
        }

        .message.user .message-content a {
            color: #93c5fd;
        }

        .message.user .message-content code {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .message.assistant .message-content {
            background: var(--bg-assistant);
            border: 1px solid var(--border-color);
            border-radius: 20px 20px 20px 4px;
            box-shadow: var(--shadow-sm);
        }

        [data-theme="dark"] .message.assistant .message-content {
            border-color: var(--bg-tertiary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .message-content mark {
            background: #fef08a;
            padding: 1px 2px;
            border-radius: 2px;
        }

        .message-content mark.current-match {
            background: #f97316;
            color: white;
            outline: 2px solid #f97316;
            outline-offset: 1px;
        }

        /* Tool Use */
        .tool-use {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            font-size: 12px;
        }

        .tool-use-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .tool-use-header svg {
            width: 14px;
            height: 14px;
        }

        .tool-use-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .tool-use-input {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .tool-params {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .tool-param {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .tool-param-key {
            flex-shrink: 0;
            font-size: 11px;
            font-weight: 600;
            color: var(--accent);
            background: var(--accent-light);
            padding: 2px 8px;
            border-radius: 4px;
            min-width: 80px;
            text-align: right;
        }

        .tool-param-value {
            font-size: 11px;
            color: var(--text-primary);
            word-break: break-word;
            line-height: 1.4;
            padding: 2px 0;
        }

        .tool-json {
            margin: 0;
            font-size: 11px;
            line-height: 1.4;
            color: var(--text-secondary);
        }

        /* Tool Use Collapsible */
        .tool-use.collapsed .tool-use-input {
            display: none;
        }

        .tool-use-toggle {
            cursor: pointer;
            padding: 2px 6px;
            font-size: 10px;
            color: var(--text-muted);
            background: var(--bg-secondary);
            border: none;
            border-radius: 4px;
            margin-left: auto;
            transition: all 0.15s ease;
        }

        .tool-use-toggle:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .tool-use-toggle svg {
            width: 12px;
            height: 12px;
            transition: transform 0.2s ease;
        }

        .tool-use.collapsed .tool-use-toggle svg {
            transform: rotate(-90deg);
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            cursor: pointer;
            user-select: none;
            transition: var(--transition);
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .toggle-switch:hover {
            background: var(--border-color);
        }

        .toggle-switch.active {
            background: var(--accent);
            color: white;
        }

        .toggle-switch .toggle-icon {
            width: 16px;
            height: 16px;
        }

        /* Tool Call Global Toggle (legacy) */
        .tool-call-toggle-container {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 16px;
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .tool-call-toggle-container input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: var(--accent-color);
        }

        .tool-call-toggle-container label {
            cursor: pointer;
            user-select: none;
        }

        /* Hidden tool uses */
        .conversation.hide-tools .tool-use {
            display: none;
        }

        .conversation.hide-tools .tool-indicator {
            display: none;
        }

        .conversation.hide-tools .tool-only-message {
            display: none;
        }

        /* Tool indicator text style */
        .tool-indicator {
            display: block;
            color: var(--text-muted);
            font-size: 12px;
            font-style: italic;
            margin: 4px 0;
        }

        /* Markdown rendered content styles */
        .message-content.markdown-rendered {
            line-height: 1.6;
        }

        .message-content.markdown-rendered h1 {
            font-size: 1.8em;
            font-weight: 700;
            margin: 16px 0 8px 0;
            padding-bottom: 6px;
            border-bottom: 2px solid var(--border-color);
            color: var(--text-primary);
        }

        .message-content.markdown-rendered h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin: 14px 0 6px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .message-content.markdown-rendered h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin: 12px 0 6px 0;
            color: var(--text-primary);
        }

        .message-content.markdown-rendered h4 {
            font-size: 1.1em;
            font-weight: 600;
            margin: 10px 0 4px 0;
            color: var(--text-primary);
        }

        .message-content.markdown-rendered h5,
        .message-content.markdown-rendered h6 {
            font-size: 1em;
            font-weight: 600;
            margin: 8px 0 4px 0;
            color: var(--text-secondary);
        }

        .message-content.markdown-rendered p {
            margin: 8px 0;
        }

        .message-content.markdown-rendered strong {
            font-weight: 700;
            color: var(--text-primary);
        }

        .message-content.markdown-rendered em {
            font-style: italic;
        }

        .message-content.markdown-rendered code {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.9em;
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            color: #e06c75;
        }

        .message-content.markdown-rendered pre {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
            border: 1px solid var(--border-color);
        }

        .message-content.markdown-rendered pre code {
            background: none;
            padding: 0;
            color: var(--text-primary);
            font-size: 13px;
            line-height: 1.5;
        }

        .message-content.markdown-rendered blockquote {
            border-left: 4px solid var(--accent-color);
            margin: 12px 0;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
        }

        .message-content.markdown-rendered blockquote p {
            margin: 4px 0;
        }

        .message-content.markdown-rendered ul,
        .message-content.markdown-rendered ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .message-content.markdown-rendered li {
            margin: 4px 0;
        }

        .message-content.markdown-rendered li > ul,
        .message-content.markdown-rendered li > ol {
            margin: 4px 0;
        }

        .message-content.markdown-rendered a {
            color: var(--accent-color);
            text-decoration: none;
        }

        .message-content.markdown-rendered a:hover {
            text-decoration: underline;
        }

        .message-content.markdown-rendered hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 16px 0;
        }

        .message-content.markdown-rendered table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
            font-size: 14px;
        }

        .message-content.markdown-rendered th,
        .message-content.markdown-rendered td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
        }

        .message-content.markdown-rendered th {
            background: var(--bg-tertiary);
            font-weight: 600;
        }

        .message-content.markdown-rendered tr:nth-child(even) {
            background: var(--bg-secondary);
        }

        .message-content.markdown-rendered img {
            max-width: 100%;
            border-radius: 8px;
            margin: 8px 0;
        }

        .message-content.markdown-rendered del {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        /* Task list (checkbox) style */
        .message-content.markdown-rendered input[type="checkbox"] {
            margin-right: 6px;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Rename Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 24px;
            width: 440px;
            max-width: 90%;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-muted);
            line-height: 1;
            padding: 0;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .modal-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
            margin-bottom: 16px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .modal-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 10px 18px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .modal-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-btn.primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .modal-btn.primary:hover {
            background: #1d4ed8;
            border-color: #1d4ed8;
        }

        .modal-btn.danger {
            color: #ef4444;
            border-color: #fecaca;
        }

        .modal-btn.danger:hover {
            background: #fef2f2;
        }

        .modal-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 12px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
        }

        /* Modal mobile responsive */
        @media (max-width: 480px) {
            .modal {
                margin: 16px;
                padding: 20px;
            }

            .modal-header h3 {
                font-size: 16px;
            }

            .modal-input,
            .modal-textarea {
                font-size: 16px; /* Prevents iOS zoom */
            }

            .modal-actions {
                flex-direction: column-reverse;
            }

            .modal-btn {
                width: 100%;
                padding: 14px;
            }
        }

        /* Scroll buttons */
        .scroll-buttons {
            position: fixed;
            right: 32px;
            bottom: 32px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .scroll-buttons.visible {
            display: flex;
        }

        .scroll-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--accent);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .scroll-btn:hover {
            background: var(--accent-hover);
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .scroll-btn:active {
            transform: scale(0.95);
        }

        .scroll-btn svg {
            width: 24px;
            height: 24px;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .scroll-buttons {
                right: 16px;
                bottom: 90px;
                gap: 12px;
            }

            .scroll-btn {
                width: 50px;
                height: 50px;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            }

            .scroll-btn svg {
                width: 26px;
                height: 26px;
            }
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: 40px;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Mobile Toggle Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #7c3aed);
            border: none;
            color: white;
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.4);
            z-index: 1001;
            cursor: pointer;
            transition: var(--transition);
            padding: 0;
            align-items: center;
            justify-content: center;
        }

        .mobile-menu-btn:hover {
            transform: scale(1.05);
        }

        .mobile-menu-btn:active {
            transform: scale(0.95);
        }

        .mobile-menu-btn svg {
            width: 24px;
            height: 24px;
        }

        .mobile-menu-btn .icon-menu,
        .mobile-menu-btn .icon-close {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mobile-menu-btn .icon-close {
            display: none;
        }

        .mobile-menu-btn.active .icon-menu {
            display: none;
        }

        .mobile-menu-btn.active .icon-close {
            display: flex;
        }

        /* Mobile Overlay */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .mobile-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* Mobile Header Actions Menu */
        .mobile-actions-btn {
            display: none;
            padding: 12px;
            border: 2px solid var(--accent);
            border-radius: var(--radius-md);
            background: var(--accent-light);
            color: var(--accent);
            cursor: pointer;
            flex-shrink: 0;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(37, 99, 235, 0.3);
            min-width: 44px;
            min-height: 44px;
            position: relative;
            z-index: 100;
        }

        .mobile-actions-btn:active {
            background: var(--accent);
            color: white;
            transform: scale(0.95);
        }

        .mobile-actions-btn svg {
            width: 24px;
            height: 24px;
            display: block;
            pointer-events: none;
        }

        /* Desktop: show session-id-row, hide mobile-actions-btn */
        @media (min-width: 481px) {
            .mobile-actions-btn {
                display: none !important;
            }
        }

        .mobile-actions-menu {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.15);
            z-index: 1002;
            padding: 16px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .mobile-actions-menu.show {
            transform: translateY(0);
        }

        .mobile-actions-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .mobile-actions-menu-title {
            font-size: 16px;
            font-weight: 600;
        }

        .mobile-actions-close {
            padding: 8px;
            border: none;
            background: none;
            color: var(--text-muted);
            cursor: pointer;
        }

        .mobile-actions-close svg {
            width: 24px;
            height: 24px;
            display: block;
        }

        .mobile-actions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .mobile-action-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: var(--transition);
        }

        .mobile-action-item:hover, .mobile-action-item:active {
            background: var(--accent-light);
            border-color: var(--accent);
        }

        .mobile-action-item svg {
            width: 24px;
            height: 24px;
            color: var(--text-secondary);
        }

        .mobile-action-item span {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
        }

        .mobile-action-item.danger {
            border-color: #fecaca;
            background: #fef2f2;
        }

        .mobile-action-item.danger svg {
            color: #ef4444;
        }

        .mobile-action-item.danger span {
            color: #ef4444;
        }

        /* Responsive - Tablet */
        @media (max-width: 900px) {
            .sidebar {
                width: 340px;
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main {
                width: 100%;
            }

            .mobile-menu-btn {
                display: flex;
            }

            .mobile-overlay {
                display: block;
            }
        }

        /* Responsive - Mobile (iPhone Air optimized: ~375px CSS width) */
        @media (max-width: 480px) {
            /* Safe area support - only for app container, not body */
            .app {
                padding-top: env(safe-area-inset-top);
            }

            .sidebar {
                width: 100%;
                padding-top: env(safe-area-inset-top);
            }

            .sidebar-header {
                padding: 16px;
            }

            .logo {
                margin-bottom: 12px;
            }

            .logo-icon {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .logo-text {
                font-size: 16px;
            }

            .stats-row {
                gap: 12px;
                margin-bottom: 12px;
            }

            .stat-value {
                font-size: 22px;
            }

            .stat-label {
                font-size: 10px;
            }

            .search-box input {
                padding: 12px 14px 12px 40px;
                font-size: 16px; /* Prevents iOS zoom on focus */
            }

            .filters {
                padding: 10px 16px;
                gap: 6px;
            }

            .filter-btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .session-group-header {
                padding: 8px 16px;
                font-size: 11px;
            }

            .session-item {
                padding: 14px 16px;
            }

            .session-preview {
                font-size: 14px;
                -webkit-line-clamp: 3;
            }

            .session-project {
                font-size: 12px;
            }

            /* Main content mobile - FIXED HEADER LAYOUT */
            .main-header {
                padding: 12px 16px;
                padding-right: 56px; /* Space for actions button */
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
                position: relative;
                min-height: 60px;
            }

            .main-header > div:first-child {
                width: 100%;
                padding-right: 0;
            }

            .main-title {
                font-size: 15px;
                line-height: 1.3;
                word-break: break-word;
            }

            .main-meta {
                font-size: 11px;
            }

            /* Hide desktop session ID row, use mobile actions instead */
            .session-id-row {
                display: none !important;
            }

            /* Mobile actions button - FIXED POSITIONING */
            .mobile-actions-btn {
                display: flex !important;
                position: absolute !important;
                right: 12px;
                top: 12px;
                transform: none;
                width: 40px;
                height: 40px;
                z-index: 10;
            }

            /* Conversation search - ENSURE TOUCHABLE */
            .conversation-search {
                padding: 12px 16px;
                position: relative;
                z-index: 50;
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border-color);
            }

            .conversation-search input {
                width: 100%;
                max-width: 100%;
                font-size: 16px; /* Prevents iOS zoom */
                padding: 14px 16px;
                -webkit-appearance: none;
                appearance: none;
                border-radius: var(--radius-md);
                border: 2px solid var(--border-color);
                background: var(--bg-tertiary);
                touch-action: manipulation !important;
                pointer-events: auto !important;
                -webkit-user-select: text !important;
                user-select: text !important;
            }

            .conversation-search input:focus {
                border-color: var(--accent);
                background: white;
                outline: none;
            }

            .conversation-search input::placeholder {
                color: var(--text-muted);
            }

            .search-results-info {
                font-size: 11px;
            }

            .conversation {
                padding: 16px;
            }

            .message {
                margin-bottom: 16px;
            }

            .message-header {
                gap: 8px;
                margin-bottom: 6px;
            }

            .message-avatar {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .message-role {
                font-size: 12px;
            }

            .message-time {
                font-size: 10px;
            }

            .message-content {
                padding: 14px;
                font-size: 14px;
                line-height: 1.7;
                /* CRITICAL: Enable text selection on mobile */
                -webkit-user-select: text !important;
                user-select: text !important;
                -webkit-touch-callout: default !important;
                touch-action: auto !important;
                cursor: text;
            }

            .tool-use {
                margin-top: 10px;
                padding: 10px;
            }

            .tool-use-header {
                font-size: 11px;
            }

            .tool-use-input {
                font-size: 10px;
                max-height: 100px;
            }

            /* Mobile FAB position */
            .mobile-menu-btn {
                bottom: calc(16px + env(safe-area-inset-bottom));
                right: 16px;
                width: 52px;
                height: 52px;
            }

            .mobile-menu-btn svg {
                width: 22px;
                height: 22px;
            }

            /* Empty state mobile */
            .empty-state {
                padding: 24px;
            }

            .empty-state svg {
                width: 48px;
                height: 48px;
            }

            .empty-state-title {
                font-size: 16px;
            }

            .empty-state p {
                font-size: 13px;
            }

            /* Date dropdown mobile - HIGH Z-INDEX */
            .date-dropdown {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0;
                padding: 20px;
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
                min-width: auto;
                max-height: 70vh;
                overflow-y: auto;
                z-index: 1100;
                box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.2);
            }

            .date-quick-filters {
                justify-content: center;
            }

            .date-quick-btn {
                padding: 10px 14px;
                font-size: 13px;
            }

            .date-inputs {
                flex-direction: column;
                gap: 12px;
            }

            .date-dropdown input {
                padding: 12px;
                font-size: 16px;
                -webkit-appearance: none;
                appearance: none;
            }

            .date-dropdown-actions button {
                padding: 14px;
                font-size: 14px;
            }

            /* Project dropdown mobile - HIGH Z-INDEX & VISIBILITY */
            .project-dropdown {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0;
                padding: 16px;
                padding-bottom: calc(16px + env(safe-area-inset-bottom));
                min-width: auto;
                max-height: 60vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                touch-action: pan-y;
                z-index: 1100;
                box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
                background: var(--bg-secondary);
                border-top: 3px solid var(--accent);
            }

            /* Add title bar for mobile dropdowns */
            .project-dropdown::after {
                content: ' ';
                display: block;
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                padding: 12px 16px;
                background: var(--accent);
                color: white;
                font-weight: 600;
                font-size: 14px;
                text-align: center;
                margin: -16px -16px 16px -16px;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            }

            .project-dropdown {
                padding-top: 56px; /* Space for title */
            }

            /* Add backdrop for dropdowns on mobile */
            .date-dropdown.show::before,
            .project-dropdown.show::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: -1;
            }

            .project-option {
                padding: 14px 12px;
                font-size: 14px;
                border-bottom: 1px solid var(--border-color);
                touch-action: manipulation;
            }

            .project-option:last-child {
                border-bottom: none;
            }

            .project-option.selected {
                background: var(--accent-light);
                border-left: 4px solid var(--accent);
            }

            /* Scrollbar hide on mobile */
            ::-webkit-scrollbar {
                width: 0;
                display: none;
            }
        }

        /* Extra small devices */
        @media (max-width: 360px) {
            .mobile-actions-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-row {
                flex-wrap: wrap;
            }

            .stat {
                flex: 1;
                min-width: 60px;
            }
        }

        /* Touch-specific improvements */
        @media (pointer: coarse) {
            .filter-btn,
            .date-quick-btn,
            .project-option,
            .session-item {
                min-height: 44px;
            }

            .mobile-action-item {
                min-height: 80px;
            }

            /* Prevent text selection on interactive elements only */
            .session-item,
            .filter-btn,
            .mobile-action-item,
            .mobile-menu-btn,
            .mobile-actions-btn {
                -webkit-user-select: none;
                user-select: none;
                -webkit-touch-callout: none;
            }

            /* Smooth scrolling - CRITICAL for touch scroll */
            .session-list,
            .conversation,
            .project-dropdown,
            .date-dropdown {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
            }

            /* Active states for touch feedback */
            .session-item:active {
                background: var(--bg-tertiary);
            }

            .mobile-action-item:active {
                transform: scale(0.98);
            }
        }

        /* CRITICAL: Enable touch actions for scrollable areas */
        .conversation {
            touch-action: pan-y !important;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        .session-list {
            touch-action: pan-y !important;
        }

        /* CRITICAL: Allow text selection in message content */
        .message-content {
            -webkit-user-select: text !important;
            user-select: text !important;
            -webkit-touch-callout: default !important;
            touch-action: auto !important;
        }

        /* Ensure interactive elements are touchable */
        .mobile-actions-btn,
        .mobile-menu-btn,
        .filter-btn,
        .mobile-action-item {
            touch-action: manipulation;
            cursor: pointer;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }

        /* Ensure search inputs are touchable */
        #conversationSearch,
        #sessionSearch {
            touch-action: manipulation !important;
            -webkit-user-select: text !important;
            user-select: text !important;
            pointer-events: auto !important;
        }

        /* Ensure message content is always selectable */
        .message-content {
            -webkit-user-select: text;
            user-select: text;
        }

        /* Project Filter Dropdown */
        .project-filter {
            position: relative;
        }

        .project-dropdown {
            display: none;
        }

        .project-dropdown.show {
            display: block;
        }

        @media (min-width: 481px) {
            .project-dropdown {
                position: absolute;
                top: calc(100% + 8px);
                left: 0;
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-md);
                box-shadow: var(--shadow-lg);
                padding: 8px;
                z-index: 100;
                display: none;
                min-width: 280px;
                max-height: 300px;
                overflow-y: auto;
            }

            .project-dropdown.show {
                display: block;
            }

            .project-option {
                padding: 8px 12px;
                border-radius: var(--radius-sm);
                cursor: pointer;
                font-size: 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .project-option:hover {
                background: var(--bg-tertiary);
            }

            .project-option.selected {
                background: var(--accent-light);
                color: var(--accent);
            }

            .project-count {
                font-size: 10px;
                background: var(--bg-tertiary);
                padding: 2px 6px;
                border-radius: 8px;
                color: var(--text-muted);
            }

            /* Conversation Search */
            .conversation-search {
                padding: 12px 24px;
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border-color);
            }

            .conversation-search input {
                width: 100%;
                max-width: 400px;
                padding: 8px 12px;
                border: 1px solid var(--border-color);
                border-radius: var(--radius-sm);
                font-size: 13px;
            }

            .conversation-search input:focus {
                outline: none;
                border-color: var(--accent);
            }

            .search-results-info {
                font-size: 12px;
                color: var(--text-muted);
                margin-top: 8px;
            }
        }

        /* Session ID and Copy Button */
        .session-id-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
            flex-wrap: wrap;
        }

        .session-id {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .copy-resume-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border: 1px solid var(--accent);
            border-radius: var(--radius-sm);
            background: var(--accent-light);
            color: var(--accent);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .copy-resume-btn:hover {
            background: var(--accent);
            color: white;
        }

        .copy-resume-btn.copied {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .copy-resume-btn.skip-perms {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #d97706;
        }

        .copy-resume-btn.skip-perms:hover {
            background: #f59e0b;
            color: white;
        }

        .copy-resume-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Resume Options Menu */
        .resume-options-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 160px;
            display: none;
        }

        .resume-options-menu.show {
            display: block;
        }

        .resume-options-menu button {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 10px 14px;
            border: none;
            background: none;
            font-size: 13px;
            color: var(--text);
            cursor: pointer;
            text-align: left;
        }

        .resume-options-menu button:hover {
            background: var(--hover);
        }

        .resume-options-menu button:first-child {
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .resume-options-menu button:last-child {
            border-radius: 0 0 var(--radius) var(--radius);
        }

        .resume-options-menu .divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        .resume-options-menu .menu-section-title {
            padding: 6px 14px 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            background: none;
            cursor: default;
        }

        .resume-btn-wrapper {
            position: relative;
            display: inline-block;
        }

        /* Delete Button */
        .delete-session-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border: 1px solid #ef4444;
            border-radius: var(--radius-sm);
            background: #fef2f2;
            color: #ef4444;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            margin-left: auto;
        }

        .delete-session-btn:hover {
            background: #ef4444;
            color: white;
        }

        .delete-session-btn.copied {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .delete-session-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Refresh Button */
        /* Theme Toggle Button */
        .theme-toggle-btn {
            margin-left: auto;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .theme-toggle-btn svg {
            width: 16px;
            height: 16px;
            display: block;
        }

        .theme-toggle-btn .icon-moon {
            display: none;
        }

        [data-theme="dark"] .theme-toggle-btn .icon-sun {
            display: none;
        }

        [data-theme="dark"] .theme-toggle-btn .icon-moon {
            display: block;
        }

        .refresh-btn {
            margin-left: 4px;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
        }

        .refresh-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .refresh-btn.copied {
            border-color: var(--success);
            color: var(--success);
        }

        .refresh-btn svg {
            width: 16px;
            height: 16px;
            display: block;
        }

        .refresh-btn.loading {
            pointer-events: none;
            opacity: 0.6;
        }

        .refresh-btn.loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Rename Button */
        .rename-session-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .rename-session-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .rename-session-btn.copied {
            border-color: var(--success);
            color: var(--success);
        }

        .rename-session-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Copy MD Button */
        .copy-md-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border: 1px solid #8b5cf6;
            border-radius: var(--radius-sm);
            background: #f5f3ff;
            color: #8b5cf6;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .copy-md-btn:hover {
            background: #8b5cf6;
            color: white;
        }

        .copy-md-btn.copied {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .copy-md-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Save MD Button */
        .save-md-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border: 1px solid #0891b2;
            border-radius: var(--radius-sm);
            background: #ecfeff;
            color: #0891b2;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .save-md-btn:hover {
            background: #0891b2;
            color: white;
        }

        .save-md-btn.copied {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .save-md-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Copy/Save MD Full Buttons */
        .copy-md-full-btn, .save-md-full-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border: 1px solid #059669;
            border-radius: var(--radius-sm);
            background: #ecfdf5;
            color: #059669;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .copy-md-full-btn:hover, .save-md-full-btn:hover {
            background: #059669;
            color: white;
        }

        .copy-md-full-btn.copied, .save-md-full-btn.copied {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .copy-md-full-btn svg, .save-md-full-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Custom name badge */
        .custom-name-badge {
            font-size: 10px;
            background: var(--assistant-light);
            color: var(--assistant-accent);
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: 6px;
        }

        /* Description style in session list */
        .session-description {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
            padding: 6px 8px;
            background: var(--bg-secondary);
            border-radius: 6px;
            border-left: 3px solid var(--border-color);
            line-height: 1.4;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Tag styles */
        .session-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .session-tag {
            font-size: 10px;
            background: #e0f2fe;
            color: #0369a1;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .session-tag.named-tag {
            background: var(--assistant-light);
            color: var(--assistant-accent);
        }

        .tag-remove {
            cursor: pointer;
            opacity: 0.6;
            font-size: 12px;
            line-height: 1;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        /* Header tags section */
        .header-tags-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .header-tag {
            font-size: 11px;
            background: #e0f2fe;
            color: #0369a1;
            padding: 3px 10px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .header-tag.named-tag {
            background: var(--assistant-light);
            color: var(--assistant-accent);
        }

        .header-tag .tag-remove {
            font-size: 14px;
        }

        .add-tag-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border: 1px dashed var(--border-color);
            border-radius: 12px;
            background: transparent;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            transition: var(--transition);
        }

        .add-tag-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .add-tag-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Header description section */
        .header-description-row {
            margin-top: 10px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .header-description-content {
            flex: 1;
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
        }

        .header-description-placeholder {
            flex: 1;
            font-size: 13px;
            color: var(--text-muted);
            font-style: italic;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px dashed var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .header-description-placeholder:hover {
            border-color: var(--accent);
            color: var(--text-secondary);
        }

        .edit-description-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .edit-description-btn:hover {
            background: var(--accent);
            color: white;
        }

        .edit-description-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Tag Filter Dropdown */
        .tag-filter {
            position: relative;
        }

        .tag-dropdown {
            display: none;
        }

        .tag-dropdown.show {
            display: block;
        }

        @media (min-width: 481px) {
            .tag-dropdown {
                position: absolute;
                top: calc(100% + 8px);
                left: 0;
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-md);
                box-shadow: var(--shadow-lg);
                padding: 8px;
                z-index: 100;
                display: none;
                min-width: 280px;
                max-height: 350px;
                overflow-y: auto;
            }

            .tag-dropdown.show {
                display: block;
            }
        }

        @media (max-width: 480px) {
            .tag-dropdown {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0;
                padding: 16px;
                padding-bottom: calc(16px + env(safe-area-inset-bottom));
                min-width: auto;
                max-height: 60vh;
                overflow-y: auto;
                z-index: 1100;
                box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
                background: var(--bg-secondary);
                border-top: 3px solid #0369a1;
            }
        }

        .tag-search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 13px;
            margin-bottom: 8px;
        }

        .tag-search-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .tag-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 12px;
        }

        .tag-option:hover {
            background: var(--bg-tertiary);
        }

        .tag-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .tag-option-label {
            flex: 1;
        }

        .tag-option-count {
            font-size: 10px;
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 8px;
            color: var(--text-muted);
        }

        .tag-dropdown-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        .tag-dropdown-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .tag-dropdown-actions .clear-tags {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .tag-dropdown-actions .clear-tags:hover {
            background: var(--border-color);
        }

        /* Search scope dropdown */
        .search-scope-container {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
            margin-bottom: 12px;
        }

        .search-scope-select {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 12px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
        }

        .search-scope-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-scope-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: 12px;
        }

        /* Sidebar Collapse */
        .sidebar.collapsed {
            width: 60px;
            min-width: 60px;
        }

        .sidebar.collapsed .sidebar-header,
        .sidebar.collapsed .filters,
        .sidebar.collapsed .search-scope-container,
        .sidebar.collapsed .session-list .session-item > *:not(.session-icon) {
            display: none;
        }

        .sidebar.collapsed .session-list {
            padding: 8px;
        }

        .sidebar-toggle-btn {
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 48px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: all 0.2s;
        }

        .sidebar-toggle-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .sidebar-toggle-btn svg {
            width: 14px;
            height: 14px;
            transition: transform 0.3s;
        }

        .sidebar.collapsed .sidebar-toggle-btn svg {
            transform: rotate(180deg);
        }

        /* Right Sidebar - Positioned absolutely to not affect flex column layout */
        .right-sidebar {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 320px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            z-index: 50;
        }

        .right-sidebar.collapsed {
            width: 0;
            border-left: none;
        }

        .right-sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .right-sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .right-sidebar-close {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .right-sidebar-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .right-sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .session-detail-section {
            margin-bottom: 20px;
        }

        .session-detail-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .session-detail-value {
            font-size: 13px;
            color: var(--text-primary);
            line-height: 1.5;
            word-break: break-all;
        }

        .session-detail-value.mono {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px;
            background: var(--bg-tertiary);
            padding: 8px 10px;
            border-radius: 6px;
        }

        .related-sessions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .related-session-item {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .related-session-item:hover {
            background: var(--accent-light);
        }

        .related-session-title {
            font-size: 12px;
            color: var(--text-primary);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .related-session-meta {
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .quick-action-btn:hover {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .quick-action-btn svg {
            width: 16px;
            height: 16px;
            color: var(--text-muted);
        }

        .quick-action-btn .shortcut {
            margin-left: auto;
            font-size: 10px;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
        }

        /* Keyboard Shortcuts Modal */
        .shortcuts-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .shortcuts-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .shortcuts-modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .shortcuts-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .shortcuts-modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .shortcuts-modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
        }

        .shortcuts-modal-close:hover {
            background: var(--bg-tertiary);
        }

        .shortcuts-section {
            margin-bottom: 20px;
        }

        .shortcuts-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .shortcut-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .shortcut-row:last-child {
            border-bottom: none;
        }

        .shortcut-desc {
            font-size: 13px;
            color: var(--text-primary);
        }

        .shortcut-keys {
            display: flex;
            gap: 4px;
        }

        .shortcut-key {
            font-size: 11px;
            font-family: 'SF Mono', Monaco, monospace;
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        /* Settings Modal */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .settings-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .settings-modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .settings-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .settings-modal-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-modal-title svg {
            width: 20px;
            height: 20px;
            color: var(--accent);
        }

        .settings-modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-modal-close:hover {
            background: var(--bg-tertiary);
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-size: 13px;
            color: var(--text-primary);
        }

        .settings-label-desc {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .settings-select {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 12px;
            min-width: 140px;
        }

        .settings-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .settings-toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
        }

        .settings-toggle.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .settings-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .settings-toggle.active::after {
            left: 22px;
        }

        .settings-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .settings-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .settings-btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .settings-btn-secondary:hover {
            background: var(--bg-secondary);
        }

        .settings-btn-primary {
            background: var(--accent);
            border: 1px solid var(--accent);
            color: white;
        }

        .settings-btn-primary:hover {
            opacity: 0.9;
        }

        /* Quick Search Modal (Cmd+Shift+O) */
        .quick-search-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 15vh;
            z-index: 2100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s ease;
        }

        .quick-search-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .quick-search-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            width: 600px;
            max-width: 90%;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid var(--border-color);
            transform: translateY(-20px);
            transition: transform 0.15s ease;
        }

        .quick-search-modal.show .quick-search-content {
            transform: translateY(0);
        }

        .quick-search-input-wrapper {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            gap: 12px;
        }

        .quick-search-input-wrapper svg {
            width: 20px;
            height: 20px;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .quick-search-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 16px;
            color: var(--text-primary);
            outline: none;
        }

        .quick-search-input::placeholder {
            color: var(--text-muted);
        }

        .quick-search-shortcut {
            font-size: 11px;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .quick-search-results {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
            max-height: 400px;
        }

        .quick-search-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 14px;
        }

        .quick-search-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.1s ease;
        }

        .quick-search-item:hover,
        .quick-search-item.selected {
            background: var(--accent-light);
        }

        .quick-search-item.selected {
            border-left: 3px solid var(--accent);
            padding-left: 17px;
        }

        .quick-search-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--text-muted);
        }

        .quick-search-item-icon svg {
            width: 16px;
            height: 16px;
        }

        .quick-search-item-content {
            flex: 1;
            min-width: 0;
        }

        .quick-search-item-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .quick-search-item-title mark {
            background: var(--warning);
            color: var(--text-primary);
            padding: 0 2px;
            border-radius: 2px;
        }

        .quick-search-item-meta {
            display: flex;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .quick-search-item-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .quick-search-item-main {
            flex: 1;
            min-width: 0;
        }

        .quick-search-item-project {
            color: var(--accent);
        }

        .quick-search-item-count {
            color: var(--text-muted);
        }

        .quick-search-item-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        .quick-search-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        .quick-search-footer {
            padding: 12px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 16px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .quick-search-footer-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-search-footer-key {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 10px;
        }

        /* Obsidian-inspired Styles */
        .properties-section {
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-primary);
        }
        
        .properties-header {
            display: flex;
            align-items: center;
            padding: 8px 24px;
            cursor: pointer;
            user-select: none;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: color 0.2s;
        }
        
        .properties-header:hover {
            color: var(--text-primary);
        }
        
        .properties-header svg {
            width: 14px;
            height: 14px;
            margin-right: 4px;
            transition: transform 0.2s;
            color: var(--text-muted);
        }
        
        .properties-section.collapsed .properties-header svg {
            transform: rotate(-90deg);
        }
        
        .properties-content {
            padding: 4px 24px 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .properties-section.collapsed .properties-content {
            display: none;
        }
        
        .property-row {
            display: flex;
            font-size: 13px;
            line-height: 1.6;
            align-items: flex-start;
        }
        
        .property-key {
            width: 100px;
            color: var(--text-muted);
            flex-shrink: 0;
            font-size: 12px;
        }
        
        .property-value {
            color: var(--text-primary);
            flex: 1;
            word-break: break-all;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .pill-tag {
            font-size: 11px;
            padding: 2px 10px;
            border-radius: 12px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid transparent;
            transition: all 0.2s;
            cursor: default;
        }
        
        .pill-tag:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--bg-secondary);
        }
        
        .pill-tag .remove-tag {
            margin-left: 4px;
            cursor: pointer;
            opacity: 0.5;
        }
        
        .pill-tag .remove-tag:hover {
            opacity: 1;
            color: var(--danger);
        }
        
        .add-tag-pill {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            border: 1px dashed var(--border-color);
            color: var(--text-muted);
            cursor: pointer;
            background: transparent;
            transition: all 0.2s;
        }
        
        .add-tag-pill:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Refined Sidebar */
        .session-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            border-left: 3px solid transparent;
        }
        
        .session-item:hover {
            background: var(--bg-tertiary);
        }
        
        .session-item.active {
            background: var(--bg-secondary);
            border-left-color: var(--accent);
        }
        
        .session-item-header {
            margin-bottom: 4px;
        }
        
        .session-time {
            font-size: 11px;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
        }
        
        .session-preview {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 6px;
        }
        
        .session-meta-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .session-tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .mini-pill {
            font-size: 9px;
            padding: 1px 6px;
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        /* Property Value Action Buttons */
        .prop-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            padding: 2px;
            display: flex;
            align-items: center;
            transition: color 0.2s;
        }
        
        .prop-action-btn:hover {
            color: var(--accent);
        }
        
        .prop-action-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Enhanced Actions UI */
        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .action-btn-group {
            display: flex;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: transparent;
            border: none;
            border-right: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            height: 32px;
        }

        .action-btn:last-child {
            border-right: none;
        }

        .action-btn:hover {
            background: var(--bg-hover);
        }

        .action-btn.danger:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .action-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Dropdown Menu */
        .dropdown-container {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 1000;
            display: none;
            padding: 4px 0;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: var(--bg-hover);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        .dropdown-header {
            padding: 4px 12px;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Sidebar Collapsed Improvements */
        .sidebar.collapsed .session-list .session-item {
            padding: 10px;
            justify-content: center;
        }

        .sidebar.collapsed .session-list .session-item .session-content,
        .sidebar.collapsed .session-list .session-item .session-meta,
        .sidebar.collapsed .session-list .session-item .session-tags {
            display: none !important;
        }

        .sidebar.collapsed .session-list .session-item .session-icon {
            margin-right: 0;
            width: 20px;
            height: 20px;
        }

        /* Updated Sidebar Collapsed Logic */
        .sidebar.collapsed .session-list .session-item {
            justify-content: center;
            padding: 12px 0;
        }
        
        .sidebar.collapsed .session-content-wrapper {
            display: none !important;
        }
        
        .sidebar.collapsed .session-icon {
            display: flex !important;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }
        
        .sidebar.collapsed .session-item.active .session-icon {
            color: var(--accent);
        }
    </style>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Scroll buttons -->
    <div class="scroll-buttons" id="scrollButtons">
        <button class="scroll-btn" id="scrollTopBtn" title=" ">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
            </svg>
        </button>
        <button class="scroll-btn" id="scrollBottomBtn" title=" ">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </button>
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Mobile Menu Button (FAB) -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <span class="icon-menu">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        </span>
        <span class="icon-close">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </span>
    </button>

    <!-- Mobile Actions Menu (Bottom Sheet) -->
    <div class="mobile-actions-menu" id="mobileActionsMenu">
        <div class="mobile-actions-menu-header">
            <span class="mobile-actions-menu-title">Session Actions</span>
            <button class="mobile-actions-close" id="mobileActionsClose">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="mobile-actions-grid">
            <div class="mobile-action-item" id="mobileResumeBtn">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <span>Resume</span>
            </div>
            <div class="mobile-action-item" id="mobileResumeSkipBtn">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <span>Resume (Skip)</span>
            </div>
            <div class="mobile-action-item" id="mobileRenameBtn">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                <span>Rename</span>
            </div>
            <div class="mobile-action-item" id="mobileCopyMdBtn">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span>Copy MD</span>
            </div>
            <div class="mobile-action-item" id="mobileSaveMdBtn">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                <span>Save MD</span>
            </div>
            <div class="mobile-action-item danger" id="mobileDeleteBtn">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                <span>Delete</span>
            </div>
        </div>
    </div>

    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar" style="position: relative;">
            <button class="sidebar-toggle-btn" id="sidebarToggleBtn" title="Toggle sidebar ()">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <img src="assets/logo-dark.png" alt="CMDS" class="logo-img logo-dark">
                        <img src="assets/logo-light.png" alt="CMDS" class="logo-img logo-light">
                    </div>
                    <div class="agent-selector" id="agentSelector">
                        <button class="agent-selector-btn" id="agentSelectorBtn">
                            <span id="currentAgentName">Claude Code</span>
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="agent-selector-menu" id="agentSelectorMenu">
                            <button data-agent="claude" class="active">
                                <span class="agent-icon claude">C</span>
                                Claude Code
                            </button>
                            <button data-agent="opencode">
                                <span class="agent-icon opencode">O</span>
                                OpenCode
                            </button>
                        </div>
                    </div>
                    <button class="theme-toggle-btn" id="themeToggleBtn" title="Toggle theme">
                        <svg class="icon-sun" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <svg class="icon-moon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </button>
                    <button class="refresh-btn" id="refreshIndexBtn" title="Update index & refresh">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
                <div class="stats-summary" id="statsSummary">
                    <div class="stats-summary-row primary">
                        <span class="stats-icon"></span>
                        <span id="totalSessions">-</span> sessions  <span id="totalMessages">-</span>
                    </div>
                    <div class="stats-summary-row secondary" id="statsInsight">
                        <span class="stats-icon"></span>
                        <span id="statsInsightText">Loading insights...</span>
                    </div>
                    <div class="stats-summary-row tertiary" id="statsFiltered" style="display:none;">
                        <span class="stats-icon"></span>
                        <span id="filteredCount">-</span> sessions match current filters
                    </div>
                </div>
                <!-- View Toggle Tabs -->
                <div class="view-tabs">
                    <button class="view-tab active" id="sessionsTab" data-view="sessions">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        Sessions
                    </button>
                    <button class="view-tab" id="dashboardTab" data-view="dashboard">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        Dashboard
                    </button>
                </div>
                <div class="search-box" id="searchBoxContainer">
                    <input type="text" id="sessionSearch" placeholder="Search sessions...">
                </div>
            </div>

            <div class="filters">
                <div class="date-filter">
                    <button class="filter-btn" id="dateFilterBtn">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span>All Dates</span>
                    </button>
                    <div class="date-dropdown" id="dateDropdown">
                        <div class="date-quick-filters">
                            <button class="date-quick-btn" data-days="0">Today</button>
                            <button class="date-quick-btn" data-days="1">Yesterday</button>
                            <button class="date-quick-btn" data-days="7">7 Days</button>
                            <button class="date-quick-btn" data-days="30">30 Days</button>
                            <button class="date-quick-btn" data-days="90">90 Days</button>
                        </div>
                        <div class="date-inputs">
                            <div class="date-input-group">
                                <label>From</label>
                                <input type="date" id="dateFrom">
                            </div>
                            <div class="date-input-group">
                                <label>To</label>
                                <input type="date" id="dateTo">
                            </div>
                        </div>
                        <div class="date-dropdown-actions">
                            <button class="clear" id="clearDate">Clear</button>
                            <button class="apply" id="applyDate">Apply</button>
                        </div>
                    </div>
                </div>

                <div class="project-filter">
                    <button class="filter-btn" id="projectFilterBtn">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                        </svg>
                        <span>All Projects</span>
                    </button>
                    <div class="project-dropdown" id="projectDropdown"></div>
                </div>

                <div class="tag-filter">
                    <button class="filter-btn" id="tagFilterBtn">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                        </svg>
                        <span>All Tags</span>
                    </button>
                    <div class="tag-dropdown" id="tagDropdown">
                        <input type="text" class="tag-search-input" id="tagSearchInput" placeholder="Search tags...">
                        <div class="tag-options-list" id="tagOptionsList"></div>
                        <div class="tag-dropdown-actions">
                            <button class="clear-tags" id="clearTagFilter">Clear</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="search-scope-container">
                <span class="search-scope-label">Search in:</span>
                <select class="search-scope-select" id="searchScopeSelect">
                    <option value="all">All (Title+Content+Tags+Desc)</option>
                    <option value="title">Title only</option>
                    <option value="content">Content only</option>
                    <option value="title_content">Title + Content</option>
                    <option value="tags">Tags only</option>
                    <option value="description">Description only</option>
                </select>
            </div>

            <div class="session-list" id="sessionList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <div class="empty-state" id="emptyState">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                <div class="empty-state-title">Select a conversation</div>
                <p>Choose a session from the left to view the full conversation</p>
            </div>

            <div id="conversationView" style="display: none;">
                <header class="main-header" style="flex-direction: row; gap: 12px; align-items: center; padding: 12px 24px;">
                    <div style="flex: 1; display: flex; align-items: center; gap: 8px; min-width: 0;">
                        <button class="edit-title-btn" id="editTitleBtn" title="/ " style="display: none;">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <div class="main-title" id="conversationTitle" style="font-size: 18px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Conversation</div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <div class="toggle-switch active" id="toolCallToggle" title="Toggle tool calls visibility">
                            <svg class="toggle-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                            </svg>
                            <span>Tools</span>
                        </div>
                        <div class="toggle-switch" id="markdownToggle" title="Toggle markdown rendering">
                            <svg class="toggle-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <span>MD</span>
                        </div>
                        <input type="checkbox" id="showToolCalls" checked style="display:none">
                        <input type="checkbox" id="renderMarkdown" style="display:none">
                        
                        <button class="mobile-actions-btn" id="mobileActionsBtn">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                            </svg>
                        </button>
                    </div>
                </header>

                <div class="properties-section" id="propertiesSection">
                    <div class="properties-header" id="propertiesToggle">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        Properties
                    </div>
                    <div class="properties-content">
                        <div class="property-row">
                            <div class="property-key">Project</div>
                            <div class="property-value" id="propProject">
                                <span style="color: var(--text-muted);">-</span>
                            </div>
                        </div>
                        <div class="property-row">
                            <div class="property-key">Created</div>
                            <div class="property-value" id="propCreated">
                                <span style="color: var(--text-muted);">-</span>
                            </div>
                        </div>
                        <div class="property-row">
                            <div class="property-key">Messages</div>
                            <div class="property-value" id="propMessages">
                                <span style="color: var(--text-muted);">-</span>
                            </div>
                        </div>
                        <div class="property-row">
                            <div class="property-key">Tags</div>
                            <div class="property-value" id="propTags">
                                <button class="add-tag-pill" id="propAddTagBtn">+ Add tag</button>
                            </div>
                        </div>
                        <div class="property-row">
                            <div class="property-key">Session ID</div>
                            <div class="property-value">
                                <span id="propSessionId" style="font-family: monospace; color: var(--accent);"></span>
                                <button class="prop-action-btn" id="propCopyId" title="Copy ID">
                                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                </button>
                            </div>
                        </div>
                        <div class="property-row" id="propDescRow" style="display:none;">
                            <div class="property-key">Description</div>
                            <div class="property-value" id="propDescription"></div>
                        </div>
                        <div class="property-row">
                            <div class="property-key">Actions</div>
                            <div class="property-value" style="gap: 8px;">
                                <div id="sessionIdRow" style="display:none;">
                                    <span id="sessionIdDisplay"></span>
                                    <button id="copyResumeBtn"></button>
                                    <button id="copyResumeSkipBtn"></button>
                                    <button id="renameSessionBtn"></button>
                                    <button id="deleteSessionBtn"></button>
                                    <button id="copyMdBtn"></button>
                                    <button id="saveMdBtn"></button>
                                    <button id="copyMdFullBtn"></button>
                                    <button id="saveMdFullBtn"></button>
                                    <div id="resumeOptionsMenu"></div>
                                    <div id="resumeSkipOptionsMenu"></div>
                                </div>
                                <div id="headerTagsRow" style="display:none;"></div>
                                <div id="headerDescriptionRow" style="display:none;"></div>
                                <div id="conversationMeta" style="display:none;"></div>

                                <div class="action-buttons">
                                    <div class="dropdown-container">
                                        <div class="action-btn-group">
                                            <button class="action-btn" id="resumeDropdownBtn" title="Resume Options">
                                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                                Resume
                                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:10px;height:10px;margin-left:2px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                                            </button>
                                        </div>
                                        <div class="dropdown-menu" id="resumeDropdownMenu">
                                            <button class="dropdown-item" onclick="handleResumeAction('copy', false)">
                                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                                                Copy Command
                                            </button>
                                            <div class="dropdown-divider"></div>
                                            <div class="dropdown-header">Open In</div>
                                            <button class="dropdown-item" onclick="handleResumeAction('terminal', false)">Terminal</button>
                                            <button class="dropdown-item" onclick="handleResumeAction('iterm2', false)">iTerm2</button>
                                            <button class="dropdown-item" onclick="handleResumeAction('warp', false)">Warp</button>
                                            <div class="dropdown-divider"></div>
                                            <div class="dropdown-header">Bypass Permissions</div>
                                            <button class="dropdown-item" onclick="handleResumeAction('copy', true)">Copy (Bypass)</button>
                                            <button class="dropdown-item" onclick="handleResumeAction('terminal', true)">Terminal (Bypass)</button>
                                            <button class="dropdown-item" onclick="handleResumeAction('iterm2', true)">iTerm2 (Bypass)</button>
                                            <button class="dropdown-item" onclick="handleResumeAction('warp', true)">Warp (Bypass)</button>
                                        </div>
                                    </div>

                                    <div class="action-btn-group">
                                        <button class="action-btn" id="actCopyMd" title="Copy to Clipboard">
                                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                                            MD
                                        </button>
                                        <button class="action-btn" id="actDownloadMd" title="Download as File">
                                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                        </button>
                                    </div>

                                    <div class="action-btn-group">
                                        <button class="action-btn" id="actRenameNew" title="Rename Session">
                                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                        </button>
                                        <button class="action-btn danger" id="actDeleteNew" title="Delete Session">
                                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                        </button>
                                    </div>
                                    
                                    <div style="display:none">
                                        <a href="#" id="actResume">Resume</a>
                                        <a href="#" id="actCopy">Copy MD</a>
                                        <a href="#" id="actRename">Rename</a>
                                        <a href="#" id="actDelete">Delete</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="conversation-search">
                    <input type="text" id="conversationSearch" placeholder="Search in conversation...">
                    <div class="search-results-info" id="searchResultsInfo"></div>
                </div>
                <div class="conversation" id="conversationContent">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Dashboard View -->
            <div class="dashboard-view" id="dashboardView">
                <div class="dashboard-grid">
                    <!-- Summary Stats Card -->
                    <div class="dashboard-card full-width">
                        <div class="dashboard-card-title">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            Overview
                        </div>
                        <div class="dashboard-stat-grid">
                            <div class="dashboard-stat">
                                <div class="dashboard-stat-value" id="dashTotalSessions">0</div>
                                <div class="dashboard-stat-label">Total Sessions</div>
                            </div>
                            <div class="dashboard-stat">
                                <div class="dashboard-stat-value" id="dashTotalMessages">0</div>
                                <div class="dashboard-stat-label">Total Messages</div>
                            </div>
                            <div class="dashboard-stat">
                                <div class="dashboard-stat-value" id="dashTotalProjects">0</div>
                                <div class="dashboard-stat-label">Projects</div>
                            </div>
                            <div class="dashboard-stat">
                                <div class="dashboard-stat-value" id="dashAvgMessages">0</div>
                                <div class="dashboard-stat-label">Avg Msgs/Session</div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Chart -->
                    <div class="dashboard-card full-width">
                        <div class="dashboard-card-title">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            Daily Activity (Last 30 Days)
                        </div>
                        <div class="chart-container">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>

                    <!-- Messages Distribution -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                            Messages Distribution
                        </div>
                        <div class="chart-container">
                            <canvas id="messagesChart"></canvas>
                        </div>
                    </div>

                    <!-- Top Projects -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                            Top Projects
                        </div>
                        <div class="project-list" id="topProjectsList">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- Right Sidebar -->
            <aside class="right-sidebar collapsed" id="rightSidebar">
                <div class="right-sidebar-header">
                    <span class="right-sidebar-title">Session Details</span>
                    <button class="right-sidebar-close" id="rightSidebarClose" title="Close ()">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="right-sidebar-content" id="rightSidebarContent">
                    <div class="session-detail-section">
                        <div class="session-detail-label">Quick Actions</div>
                        <div class="quick-actions">
                            <button class="quick-action-btn" id="qaResume">
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /></svg>
                                Resume Session
                                <span class="shortcut">R</span>
                            </button>
                            <button class="quick-action-btn" id="qaCopyMd">
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                Copy as Markdown
                                <span class="shortcut">C</span>
                            </button>
                            <button class="quick-action-btn" id="qaRename">
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                Rename
                                <span class="shortcut">E</span>
                            </button>
                        </div>
                    </div>
                    <div class="session-detail-section">
                        <div class="session-detail-label">Session Info</div>
                        <div class="session-detail-value mono" id="rsSessionId">-</div>
                    </div>
                    <div class="session-detail-section">
                        <div class="session-detail-label">Messages</div>
                        <div class="session-detail-value" id="rsMessageCount">-</div>
                    </div>
                    <div class="session-detail-section">
                        <div class="session-detail-label">Project</div>
                        <div class="session-detail-value" id="rsProject">-</div>
                    </div>
                    <div class="session-detail-section">
                        <div class="session-detail-label">Last Activity</div>
                        <div class="session-detail-value" id="rsLastActivity">-</div>
                    </div>
                    <div class="session-detail-section" id="rsRelatedSection" style="display:none;">
                        <div class="session-detail-label">Related Sessions</div>
                        <div class="related-sessions-list" id="rsRelatedList"></div>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <script>
        // State
        let currentAgent = localStorage.getItem('agent-archives-agent') || 'claude';  // 'claude' or 'opencode'
        let allItems = [];  // Can be sessions or history entries
        let filteredItems = [];
        let currentItem = null;
        let currentMessages = [];
        let searchQuery = '';
        let dateFrom = null;
        let dateTo = null;
        let selectedProject = null;
        let selectedTags = [];  // Array of selected tag names for filtering
        let tagSearchQuery = '';  // Search query for tag dropdown
        let sessionTags = {};  // sessionId -> [tags] mapping
        let sessionDescriptions = {};  // sessionId -> description mapping
        let conversationSearchQuery = '';
        let showType = 'all'; // 'all', 'sessions', 'history'
        let searchScope = 'all';  // 'all', 'title', 'content', 'title_content', 'tags', 'description'
        let activeSessions = [];  // List of active session cwds from running processes
        let autoRefreshInterval = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSessionTags();
            await loadSessionDescriptions();
            await loadSessionIndex();
            setupEventListeners();
            setupDeepLinkHandler();
            startAutoRefresh();
            
            // Restore sidebar state
            if (localStorage.getItem('sidebar-collapsed') === 'true') {
                document.querySelector('.sidebar')?.classList.add('collapsed');
            }
        });

        function setupDeepLinkHandler() {
            if (window.electronAPI && window.electronAPI.onDeepLink) {
                window.electronAPI.onDeepLink((data) => {
                    if (data.action === 'open-session' && data.sessionId) {
                        const session = allItems.find(item => item.sessionId === data.sessionId);
                        if (session) {
                            loadSession(session.sessionId, session.projectFolder, session.fileName, session.agent || 'claude');
                        } else {
                            console.warn(`Session not found: ${data.sessionId}`);
                        }
                    }
                });
            }
        }

        // Load session tags from session-tags.json
        async function loadSessionTags() {
            try {
                const response = await fetch('session-tags.json?t=' + Date.now());
                if (response.ok) {
                    sessionTags = await response.json();
                    console.log('Loaded tags from session-tags.json');
                } else {
                    sessionTags = {};
                }
            } catch (error) {
                console.log('No session-tags.json found, starting fresh');
                sessionTags = {};
            }
        }

        // Load session descriptions from session-descriptions.json
        async function loadSessionDescriptions() {
            try {
                const response = await fetch('session-descriptions.json?t=' + Date.now());
                if (response.ok) {
                    sessionDescriptions = await response.json();
                    console.log('Loaded descriptions from session-descriptions.json');
                } else {
                    sessionDescriptions = {};
                }
            } catch (error) {
                console.log('No session-descriptions.json found, starting fresh');
                sessionDescriptions = {};
            }
        }

        // Get description for a session
        function getSessionDescription(sessionId) {
            return sessionDescriptions[sessionId] || '';
        }

        // Get tags for a session (including 'named' tag if it has customName)
        function getSessionTags(sessionId, customName) {
            const tags = sessionTags[sessionId] || [];
            // Add 'named' tag if session has customName and doesn't already have it
            if (customName && !tags.includes('named')) {
                return ['named', ...tags];
            }
            return [...tags];
        }

        // Get all unique tags across all sessions
        function getAllTags() {
            const tagCounts = {};
            allItems.forEach(item => {
                if (item.type === 'session') {
                    const tags = getSessionTags(item.sessionId, item.customName);
                    tags.forEach(tag => {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                }
            });
            return tagCounts;
        }

        // Add tag to session via API
        // Supports comma-separated multiple tags (e.g., "AI, LLM, ")
        async function addTagToSession(sessionId, tagsInput) {
            if (!tagsInput || tagsInput === 'named') return;

            try {
                const response = await fetch('/api/tags/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, tags: tagsInput })
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(`  : ${error.detail || '   '}`);
                    return;
                }

                const result = await response.json();

                // Update local sessionTags
                sessionTags[sessionId] = result.tags;

                // Update tag filter dropdown
                buildTagFilter();

                // Refresh current view
                if (currentItem?.sessionId === sessionId) {
                    refreshHeaderTags(sessionId);
                }
                applyFilters();

                // Show result message
                if (result.added && result.added.length > 0) {
                    console.log(`Added tags: ${result.added.join(', ')}`);
                }
                if (result.skipped && result.skipped.length > 0) {
                    console.log(`Skipped existing tags: ${result.skipped.join(', ')}`);
                }
            } catch (error) {
                alert(`  : ${error.message}`);
            }
        }

        // Remove tag from session via API
        async function removeTagFromSession(sessionId, tag) {
            if (tag === 'named') {
                alert("'named'   . Rename  .");
                return;
            }

            try {
                const response = await fetch('/api/tags/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, tag: tag })
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(`  : ${error.detail || '   '}`);
                    return;
                }

                const result = await response.json();

                // Update local sessionTags
                if (result.tags.length > 0) {
                    sessionTags[sessionId] = result.tags;
                } else {
                    delete sessionTags[sessionId];
                }

                // Update tag filter dropdown
                buildTagFilter();

                // Refresh current view
                if (currentItem?.sessionId === sessionId) {
                    refreshHeaderTags(sessionId);
                }
                applyFilters();

                console.log(`Removed tag: ${result.removed}`);
            } catch (error) {
                alert(`  : ${error.message}`);
            }
        }

        // Helper: Refresh header tags display for current session
        function refreshHeaderTags(sessionId) {
            const item = allItems.find(i => i.sessionId === sessionId);
            if (!item) return;

            const container = document.getElementById('headerTagsRow');
            if (!container) return;

            const tags = getSessionTags(sessionId, item.customName);

            if (tags.length === 0) {
                container.style.display = 'none';
                container.innerHTML = '';
                return;
            }

            container.style.display = 'flex';
            container.innerHTML = `
                <div class="header-tags-container">
                    ${tags.map(tag => `
                        <span class="session-tag detail-tag ${tag === 'named' ? 'named-tag' : ''}" data-tag="${tag}">
                            ${tag}
                            ${tag !== 'named' ? '<span class="tag-remove" title="Remove tag">&times;</span>' : ''}
                        </span>
                    `).join('')}
                    <button class="add-tag-btn" title="Add tag">+</button>
                </div>
            `;

            // Re-attach event listeners for tag removal
            container.querySelectorAll('.tag-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const tagEl = e.target.closest('.session-tag');
                    const tagName = tagEl.dataset.tag;
                    if (confirm(`'${tagName}'  ?`)) {
                        removeTagFromSession(sessionId, tagName);
                    }
                });
            });

            // Re-attach add tag button
            container.querySelector('.add-tag-btn')?.addEventListener('click', () => {
                openTagModal(sessionId);
            });
        }

        async function loadSessionIndex() {
            try {
                let response, data;

                if (currentAgent === 'opencode') {
                    // Load OpenCode sessions
                    response = await fetch('/api/opencode/sessions?t=' + Date.now());
                    const sessions = await response.json();

                    // Transform to common format
                    allItems = sessions.map(s => ({
                        type: 'session',
                        sessionId: s.sessionId,
                        project: s.project,
                        title: s.title,
                        preview: s.title || 'OpenCode Session',
                        lastActivity: s.lastActivity,
                        lastTimestamp: s.lastActivity,
                        messageCount: s.messageCount,
                        model: s.model?.model || 'OpenCode',
                        agent: 'opencode',
                        projectFolder: '',  // Not used for OpenCode
                        fileName: ''  // Not used for OpenCode
                    }));
                } else {
                    // Load Claude Code sessions
                    response = await fetch('sessions-index.json?t=' + Date.now());
                    data = await response.json();
                    allItems = (data.items || data.sessions || []).map(item => ({
                        ...item,
                        agent: 'claude'
                    }));
                }

                // Calculate stats
                const sessions = allItems.filter(i => i.type === 'session' || i.sessionId);
                const historyOnly = allItems.filter(i => i.type === 'history');
                const totalMessages = sessions.reduce((sum, s) => sum + (s.messageCount || 0), 0);

                document.getElementById('totalSessions').textContent = sessions.length;
                document.getElementById('totalMessages').textContent = currentAgent === 'opencode'
                    ? `${totalMessages} msgs`
                    : `${totalMessages} msgs + ${historyOnly.length} history`;

                await fetchActiveSessions();
                applyFilters();
                buildProjectFilter();
                buildTagFilter();
                generateStatsInsight();
            } catch (error) {
                console.error('Error loading session index:', error);
                const agentName = currentAgent === 'opencode' ? 'OpenCode' : 'Claude Code';
                document.getElementById('sessionList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-title">Failed to load ${agentName} sessions</div>
                        <p>${currentAgent === 'opencode'
                            ? 'Make sure OpenCode is installed and has sessions in ~/.local/share/opencode/'
                            : 'Make sure you\'re running the server from the .claude directory'}</p>
                    </div>
                `;
            }
        }

        // Generate stats insight text
        function generateStatsInsight() {
            const sessions = allItems.filter(i => i.type === 'session' || i.sessionId);
            const insightEl = document.getElementById('statsInsightText');
            
            if (sessions.length === 0) {
                insightEl.textContent = 'No sessions yet';
                return;
            }

            const now = new Date();
            const insights = [];

            // 1. Activity insight - Last 7 days vs previous 7 days
            const last7Days = sessions.filter(s => {
                const ts = s.lastTimestamp || s.lastActivity;
                if (!ts) return false;
                const diff = now - new Date(ts);
                return diff < 7 * 24 * 60 * 60 * 1000;
            }).length;

            const prev7Days = sessions.filter(s => {
                const ts = s.lastTimestamp || s.lastActivity;
                if (!ts) return false;
                const diff = now - new Date(ts);
                return diff >= 7 * 24 * 60 * 60 * 1000 && diff < 14 * 24 * 60 * 60 * 1000;
            }).length;

            if (last7Days > 0) {
                if (prev7Days > 0) {
                    const change = Math.round(((last7Days - prev7Days) / prev7Days) * 100);
                    if (change > 0) {
                        insights.push(`${last7Days} sessions this week (+${change}%)`);
                    } else if (change < 0) {
                        insights.push(`${last7Days} sessions this week (${change}%)`);
                    } else {
                        insights.push(`${last7Days} sessions this week`);
                    }
                } else {
                    insights.push(`${last7Days} sessions this week`);
                }
            }

            // 2. Most active project
            const projectCounts = {};
            sessions.forEach(s => {
                if (s.project) {
                    const projName = s.project.split('/').pop();
                    projectCounts[projName] = (projectCounts[projName] || 0) + 1;
                }
            });

            const topProject = Object.entries(projectCounts)
                .sort((a, b) => b[1] - a[1])[0];

            if (topProject && topProject[1] > 1) {
                insights.push(`Top: ${topProject[0]} (${topProject[1]})`);
            }

            // 3. Named sessions count
            const namedCount = sessions.filter(s => s.customName).length;
            if (namedCount > 0) {
                const pct = Math.round((namedCount / sessions.length) * 100);
                insights.push(`${namedCount} named (${pct}%)`);
            }

            // Set the insight text (pick 1-2 insights to keep it concise)
            if (insights.length > 0) {
                insightEl.textContent = insights.slice(0, 2).join('  ');
            } else {
                insightEl.textContent = 'Start a session to see insights';
            }
        }

        async function fetchActiveSessions() {
            try {
                const response = await fetch('/api/active-sessions');
                const data = await response.json();
                activeSessions = data.active || [];
            } catch (error) {
                activeSessions = [];
            }
        }

        function isSessionActive(item) {
            if (!item.project || activeSessions.length === 0) return false;
            const normalizedProject = '/' + item.project.replace(/^\/+/, '');
            return activeSessions.some(a => normalizedProject === a.cwd || a.cwd.endsWith(item.project));
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            
            const interval = parseInt(localStorage.getItem('settings-auto-refresh') || '60');
            if (interval > 0) {
                autoRefreshInterval = setInterval(async () => {
                    await fetchActiveSessions();
                    renderSessionList();
                }, interval * 1000);
            }
        }

        // Keyboard shortcuts handler
        function handleKeyboardShortcuts(e) {
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const mod = isMac ? e.metaKey : e.ctrlKey;
            const ctrl = e.ctrlKey;
            const shift = e.shiftKey;
            const key = e.key;
            
            // Don't trigger shortcuts when typing in input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                if (key === 'Escape') {
                    e.target.blur();
                    e.preventDefault();
                }
                return;
            }
            
            // Ctrl+Cmd+Left - Toggle left sidebar
            if (ctrl && mod && key === 'ArrowLeft') {
                e.preventDefault();
                toggleLeftSidebar();
                return;
            }
            
            // Ctrl+Cmd+Right - Toggle right sidebar
            if (ctrl && mod && key === 'ArrowRight') {
                e.preventDefault();
                toggleRightSidebar();
                return;
            }
            
            // Cmd+K - Focus session search
            if (mod && key === 'k' && !shift && !ctrl) {
                e.preventDefault();
                const searchInput = document.getElementById('sessionSearch');
                if (searchInput) {
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar?.classList.contains('collapsed')) {
                        toggleLeftSidebar();
                    }
                    searchInput.focus();
                    searchInput.select();
                }
                return;
            }
            
            // Cmd+F - Focus conversation search
            if (mod && key === 'f' && !shift && !ctrl) {
                e.preventDefault();
                const convSearch = document.getElementById('conversationSearch');
                if (convSearch && currentItem) {
                    convSearch.focus();
                    convSearch.select();
                }
                return;
            }
            
            // Cmd+Up/Down - Navigate sessions
            if (mod && (key === 'ArrowUp' || key === 'ArrowDown') && !shift && !ctrl) {
                e.preventDefault();
                navigateSession(key === 'ArrowUp' ? -1 : 1);
                return;
            }
            
            // Cmd+R - Resume session (only if no shift)
            if (mod && key === 'r' && !shift && !ctrl) {
                e.preventDefault();
                if (currentItem) {
                    document.getElementById('copyResumeBtn')?.click();
                }
                return;
            }
            
            // Cmd+Shift+R - Refresh index
            if (mod && shift && key === 'R') {
                e.preventDefault();
                document.getElementById('refreshIndexBtn')?.click();
                return;
            }
            
            // Cmd+E - Rename session
            if (mod && key === 'e' && !shift && !ctrl) {
                e.preventDefault();
                if (currentItem) {
                    document.getElementById('renameSessionBtn')?.click();
                }
                return;
            }
            
            // Cmd+Shift+C - Copy as Markdown
            if (mod && shift && key === 'C') {
                e.preventDefault();
                if (currentItem) {
                    document.getElementById('copyMdBtn')?.click();
                }
                return;
            }
            
            // Cmd+1 - Sessions view
            if (mod && key === '1' && !shift && !ctrl) {
                e.preventDefault();
                document.getElementById('sessionsTab')?.click();
                return;
            }
            
            // Cmd+2 - Dashboard view
            if (mod && key === '2' && !shift && !ctrl) {
                e.preventDefault();
                document.getElementById('dashboardTab')?.click();
                return;
            }
            
            // Cmd+Shift+D - Toggle theme
            if (mod && shift && key === 'D') {
                e.preventDefault();
                document.getElementById('themeToggleBtn')?.click();
                return;
            }
            
            // Cmd+Shift+O - Quick search
            if (mod && shift && key === 'O') {
                e.preventDefault();
                toggleQuickSearchModal(true);
                return;
            }
            
            // Cmd+/ - Show shortcuts
            if (mod && key === '/' && !shift && !ctrl) {
                e.preventDefault();
                toggleShortcutsModal(true);
                return;
            }
            
            // Cmd+, - Open settings
            if (mod && key === ',' && !shift && !ctrl) {
                e.preventDefault();
                toggleSettingsModal(true);
                return;
            }
            
            // Escape - Close modals/panels
            if (key === 'Escape') {
                toggleQuickSearchModal(false);
                toggleShortcutsModal(false);
                toggleSettingsModal(false);
                return;
            }
        }

        // Toggle left sidebar
        function toggleLeftSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar?.classList.toggle('collapsed');
            localStorage.setItem('sidebar-collapsed', sidebar?.classList.contains('collapsed'));
        }

        // Toggle right sidebar
        function toggleRightSidebar(show) {
            const rightSidebar = document.getElementById('rightSidebar');
            if (!rightSidebar) return;
            
            if (typeof show === 'boolean') {
                rightSidebar.classList.toggle('collapsed', !show);
            } else {
                rightSidebar.classList.toggle('collapsed');
            }
            
            // Update right sidebar content if opening and has current item
            if (!rightSidebar.classList.contains('collapsed') && currentItem) {
                updateRightSidebar();
            }
        }

        // Toggle shortcuts modal
        function toggleShortcutsModal(show) {
            const modal = document.getElementById('shortcutsModal');
            if (!modal) return;
            
            if (typeof show === 'boolean') {
                modal.classList.toggle('show', show);
            } else {
                modal.classList.toggle('show');
            }
        }

        // Toggle settings modal
        function toggleSettingsModal(show) {
            const modal = document.getElementById('settingsModal');
            if (!modal) return;
            
            if (typeof show === 'boolean') {
                modal.classList.toggle('show', show);
            } else {
                modal.classList.toggle('show');
            }
            
            if (modal.classList.contains('show')) {
                loadSettingsToUI();
            }
        }

        // Quick Search Modal State
        let quickSearchSelectedIndex = 0;
        let quickSearchResults = [];

        // Toggle quick search modal
        function toggleQuickSearchModal(show) {
            const modal = document.getElementById('quickSearchModal');
            const input = document.getElementById('quickSearchInput');
            if (!modal) return;
            
            if (typeof show === 'boolean') {
                modal.classList.toggle('show', show);
            } else {
                modal.classList.toggle('show');
            }
            
            if (modal.classList.contains('show')) {
                input.value = '';
                input.focus();
                quickSearchSelectedIndex = 0;
                quickSearchResults = [];
                renderQuickSearchResults([]);
            }
        }

        // Search sessions for quick search
        function quickSearchSessions(query) {
            if (!query.trim()) {
                quickSearchResults = [];
                renderQuickSearchResults([]);
                return;
            }
            
            const q = query.toLowerCase();
            quickSearchResults = allItems.filter(item => {
                const title = (item.customName || item.preview || item.title || '').toLowerCase();
                const project = (item.project || '').toLowerCase();
                const tags = getSessionTags(item.sessionId, item.customName).join(' ').toLowerCase();
                const desc = getSessionDescription(item.sessionId).toLowerCase();
                return title.includes(q) || project.includes(q) || tags.includes(q) || desc.includes(q);
            }).slice(0, 10);
            
            quickSearchSelectedIndex = 0;
            renderQuickSearchResults(quickSearchResults);
        }

        // Render quick search results
        function renderQuickSearchResults(results) {
            const container = document.getElementById('quickSearchResults');
            if (!container) return;
            
            if (results.length === 0) {
                const input = document.getElementById('quickSearchInput');
                if (input && input.value.trim()) {
                    container.innerHTML = '<div class="quick-search-empty">No sessions found</div>';
                } else {
                    container.innerHTML = '<div class="quick-search-empty">Type to search sessions...</div>';
                }
                return;
            }
            
            container.innerHTML = results.map((item, idx) => {
                const title = item.customName || item.preview || item.title || 'Untitled';
                const project = item.project ? item.project.split('/').pop() : '';
                const tags = getSessionTags(item.sessionId, item.customName);
                const msgCount = item.messageCount || 0;
                const isSelected = idx === quickSearchSelectedIndex;
                
                return `
                    <div class="quick-search-item${isSelected ? ' selected' : ''}" data-id="${item.sessionId}" data-index="${idx}">
                        <div class="quick-search-item-main">
                            <div class="quick-search-item-title">${escapeHtml(title)}</div>
                            <div class="quick-search-item-meta">
                                ${project ? `<span class="quick-search-item-project">${escapeHtml(project)}</span>` : ''}
                                <span class="quick-search-item-count">${msgCount} msgs</span>
                            </div>
                        </div>
                        ${tags.length > 0 ? `
                            <div class="quick-search-item-tags">
                                ${tags.slice(0, 3).map(tag => `<span class="quick-search-tag">${escapeHtml(tag)}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Handle quick search keyboard navigation
        function handleQuickSearchKeydown(e) {
            const key = e.key;
            
            if (key === 'ArrowDown') {
                e.preventDefault();
                if (quickSearchResults.length > 0) {
                    quickSearchSelectedIndex = (quickSearchSelectedIndex + 1) % quickSearchResults.length;
                    updateQuickSearchSelection();
                }
            } else if (key === 'ArrowUp') {
                e.preventDefault();
                if (quickSearchResults.length > 0) {
                    quickSearchSelectedIndex = quickSearchSelectedIndex <= 0 ? quickSearchResults.length - 1 : quickSearchSelectedIndex - 1;
                    updateQuickSearchSelection();
                }
            } else if (key === 'Enter') {
                e.preventDefault();
                if (quickSearchResults.length > 0 && quickSearchResults[quickSearchSelectedIndex]) {
                    const session = quickSearchResults[quickSearchSelectedIndex];
                    loadSession(session.sessionId, session.projectFolder, session.fileName, session.agent || 'claude');
                    toggleQuickSearchModal(false);
                }
            } else if (key === 'Escape') {
                e.preventDefault();
                toggleQuickSearchModal(false);
            }
        }

        // Update quick search selection highlight
        function updateQuickSearchSelection() {
            const container = document.getElementById('quickSearchResults');
            if (!container) return;
            
            container.querySelectorAll('.quick-search-item').forEach((el, idx) => {
                el.classList.toggle('selected', idx === quickSearchSelectedIndex);
                if (idx === quickSearchSelectedIndex) {
                    el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            });
        }

        // Load settings from localStorage to UI
        function loadSettingsToUI() {
            const defaultTerminal = localStorage.getItem('settings-default-terminal') || 'copy';
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const autoRefresh = localStorage.getItem('settings-auto-refresh') || '60';
            const showTools = localStorage.getItem('settings-show-tools') !== 'false';
            const renderMd = localStorage.getItem('settings-render-md') === 'true';
            
            document.getElementById('settingsDefaultTerminal').value = defaultTerminal;
            document.getElementById('settingsTheme').value = currentTheme;
            document.getElementById('settingsAutoRefresh').value = autoRefresh;
            document.getElementById('settingsShowTools').classList.toggle('active', showTools);
            document.getElementById('settingsRenderMd').classList.toggle('active', renderMd);
        }

        // Save settings from UI to localStorage
        function saveSettings() {
            const defaultTerminal = document.getElementById('settingsDefaultTerminal').value;
            const theme = document.getElementById('settingsTheme').value;
            const autoRefresh = document.getElementById('settingsAutoRefresh').value;
            const showTools = document.getElementById('settingsShowTools').classList.contains('active');
            const renderMd = document.getElementById('settingsRenderMd').classList.contains('active');
            
            // Check if auto-refresh interval changed
            const prevAutoRefresh = localStorage.getItem('settings-auto-refresh') || '60';
            const autoRefreshChanged = prevAutoRefresh !== autoRefresh;
            
            localStorage.setItem('settings-default-terminal', defaultTerminal);
            localStorage.setItem('settings-auto-refresh', autoRefresh);
            localStorage.setItem('settings-show-tools', showTools);
            localStorage.setItem('settings-render-md', renderMd);
            
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('claude-history-theme', theme);
            
            const toolToggle = document.getElementById('toolCallToggle');
            const toolCheckbox = document.getElementById('showToolCalls');
            toolToggle?.classList.toggle('active', showTools);
            if (toolCheckbox) toolCheckbox.checked = showTools;
            
            const mdToggle = document.getElementById('markdownToggle');
            const mdCheckbox = document.getElementById('renderMarkdown');
            mdToggle?.classList.toggle('active', renderMd);
            if (mdCheckbox) mdCheckbox.checked = renderMd;
            
            if (currentMessages.length > 0) {
                renderConversation();
            }
            
            // Restart auto-refresh if interval changed
            if (autoRefreshChanged && typeof startAutoRefresh === 'function') {
                startAutoRefresh();
            }
            
            toggleSettingsModal(false);
        }

        // Reset settings to defaults
        function resetSettings() {
            localStorage.removeItem('settings-default-terminal');
            localStorage.removeItem('settings-auto-refresh');
            localStorage.removeItem('settings-show-tools');
            localStorage.removeItem('settings-render-md');
            loadSettingsToUI();
        }

        // Navigate to previous/next session
        function navigateSession(direction) {
            if (!filteredItems || filteredItems.length === 0) return;
            
            const currentIndex = currentItem 
                ? filteredItems.findIndex(item => item.sessionId === currentItem.sessionId)
                : -1;
            
            let newIndex;
            if (currentIndex === -1) {
                newIndex = direction > 0 ? 0 : filteredItems.length - 1;
            } else {
                newIndex = currentIndex + direction;
                if (newIndex < 0) newIndex = filteredItems.length - 1;
                if (newIndex >= filteredItems.length) newIndex = 0;
            }
            
            const newItem = filteredItems[newIndex];
            if (newItem) {
                loadSession(newItem.sessionId, newItem.projectFolder, newItem.fileName, newItem.agent || 'claude');
                // Scroll the session into view
                const sessionEl = document.querySelector(`.session-item[data-id="${newItem.sessionId}"]`);
                sessionEl?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Update right sidebar content
        function updateRightSidebar() {
            if (!currentItem) return;
            
            document.getElementById('rsSessionId').textContent = currentItem.sessionId || '-';
            document.getElementById('rsMessageCount').textContent = `${currentItem.messageCount || 0} messages`;
            document.getElementById('rsProject').textContent = currentItem.project || 'Unknown';
            document.getElementById('rsLastActivity').textContent = currentItem.lastActivity 
                ? new Date(currentItem.lastActivity).toLocaleString('ko-KR')
                : '-';
            
            // Find related sessions (same project)
            const relatedSection = document.getElementById('rsRelatedSection');
            const relatedList = document.getElementById('rsRelatedList');
            
            if (currentItem.project && relatedList) {
                const related = allItems.filter(item => 
                    item.project === currentItem.project && 
                    item.sessionId !== currentItem.sessionId
                ).slice(0, 5);
                
                if (related.length > 0) {
                    relatedSection.style.display = 'block';
                    relatedList.innerHTML = related.map(item => `
                        <div class="related-session-item" data-id="${item.sessionId}">
                            <div class="related-session-title">${item.customName || item.preview || item.title || 'Session'}</div>
                            <div class="related-session-meta">${item.messageCount || 0} msgs</div>
                        </div>
                    `).join('');
                    
                    // Add click handlers
                    relatedList.querySelectorAll('.related-session-item').forEach(el => {
                        el.addEventListener('click', () => {
                            const item = allItems.find(i => i.sessionId === el.dataset.id);
                            if (item) loadSession(item.sessionId, item.projectFolder, item.fileName, item.agent || 'claude');
                        });
                    });
                } else {
                    relatedSection.style.display = 'none';
                }
            } else {
                relatedSection.style.display = 'none';
            }
        }

        function setupEventListeners() {
            // Theme toggle
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            const savedTheme = localStorage.getItem('claude-history-theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }

            themeToggleBtn?.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('claude-history-theme', newTheme);
            });

            // Quick Search Modal event listeners
            const quickSearchInput = document.getElementById('quickSearchInput');
            const quickSearchResults = document.getElementById('quickSearchResults');
            const quickSearchModal = document.getElementById('quickSearchModal');

            quickSearchInput?.addEventListener('input', debounce((e) => {
                quickSearchSessions(e.target.value);
            }, 150));

            quickSearchInput?.addEventListener('keydown', handleQuickSearchKeydown);

            // Click on modal backdrop to close
            quickSearchModal?.addEventListener('click', (e) => {
                if (e.target === quickSearchModal) {
                    toggleQuickSearchModal(false);
                }
            });

            // Click on result item to open session
            quickSearchResults?.addEventListener('click', (e) => {
                const item = e.target.closest('.quick-search-item');
                if (item) {
                    const sessionId = item.dataset.id;
                    const session = allItems.find(s => s.sessionId === sessionId);
                    if (session) {
                        loadSession(session.sessionId, session.projectFolder, session.fileName, session.agent || 'claude');
                        toggleQuickSearchModal(false);
                    }
                }
            });

            // Hover on result item to update selection
            quickSearchResults?.addEventListener('mouseover', (e) => {
                const item = e.target.closest('.quick-search-item');
                if (item && item.dataset.index !== undefined) {
                    quickSearchSelectedIndex = parseInt(item.dataset.index);
                    updateQuickSearchSelection();
                }
            });

            // Agent selector dropdown
            const agentSelector = document.getElementById('agentSelector');
            const agentSelectorBtn = document.getElementById('agentSelectorBtn');
            const agentSelectorMenu = document.getElementById('agentSelectorMenu');
            const currentAgentName = document.getElementById('currentAgentName');

            // Load saved agent preference - update UI only, don't reload data yet
            const savedAgentUI = localStorage.getItem('agent-archives-agent') || 'claude';
            currentAgentName.textContent = savedAgentUI === 'claude' ? 'Claude Code' : 'OpenCode';
            agentSelectorMenu.querySelectorAll('button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.agent === savedAgentUI);
            });

            function updateAgentSelection(agent, reload = true) {
                // Update global state
                currentAgent = agent;

                // Update button text
                currentAgentName.textContent = agent === 'claude' ? 'Claude Code' : 'OpenCode';

                // Update active state in menu
                agentSelectorMenu.querySelectorAll('button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.agent === agent);
                });

                // Save preference
                localStorage.setItem('agent-archives-agent', agent);

                // Reload data if requested
                if (reload) {
                    // Reset current view
                    currentItem = null;
                    currentMessages = [];
                    switchView('sessions');

                    // Reload session data
                    loadSessionIndex();
                }
            }

            agentSelectorBtn?.addEventListener('click', (e) => {
                e.stopPropagation();
                agentSelector.classList.toggle('open');
            });

            agentSelectorMenu?.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn && btn.dataset.agent) {
                    updateAgentSelection(btn.dataset.agent);
                    agentSelector.classList.remove('open');
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!agentSelector.contains(e.target)) {
                    agentSelector.classList.remove('open');
                }
            });

            // Scroll buttons
            const scrollTopBtn = document.getElementById('scrollTopBtn');
            const scrollBottomBtn = document.getElementById('scrollBottomBtn');

            scrollTopBtn.addEventListener('click', () => {
                const conversation = document.getElementById('conversationContent');
                if (conversation) {
                    conversation.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });

            scrollBottomBtn.addEventListener('click', () => {
                const conversation = document.getElementById('conversationContent');
                if (conversation) {
                    conversation.scrollTo({ top: conversation.scrollHeight, behavior: 'smooth' });
                }
            });

            // Session search
            document.getElementById('sessionSearch').addEventListener('input', debounce((e) => {
                searchQuery = e.target.value.trim().toLowerCase();
                applyFilters();
            }, 300));

            // Date filter - prevent dropdown from closing on inside click
            document.getElementById('dateDropdown').addEventListener('click', (e) => {
                e.stopPropagation();
            });

            document.getElementById('dateFilterBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('dateDropdown').classList.toggle('show');
                document.getElementById('projectDropdown').classList.remove('show');
                document.getElementById('tagDropdown').classList.remove('show');
            });

            // Quick date filter buttons
            document.querySelectorAll('.date-quick-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const days = parseInt(btn.dataset.days);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    // Clear active state from all quick buttons
                    document.querySelectorAll('.date-quick-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    if (days === 0) {
                        // Today
                        dateFrom = formatDateValue(today);
                        dateTo = formatDateValue(today);
                    } else if (days === 1) {
                        // Yesterday
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        dateFrom = formatDateValue(yesterday);
                        dateTo = formatDateValue(yesterday);
                    } else {
                        // Last N days
                        const fromDate = new Date(today);
                        fromDate.setDate(fromDate.getDate() - days);
                        dateFrom = formatDateValue(fromDate);
                        dateTo = formatDateValue(today);
                    }

                    document.getElementById('dateFrom').value = dateFrom;
                    document.getElementById('dateTo').value = dateTo;
                    updateDateFilterButton();
                    applyFilters();
                    document.getElementById('dateDropdown').classList.remove('show');
                });
            });

            document.getElementById('applyDate').addEventListener('click', () => {
                document.querySelectorAll('.date-quick-btn').forEach(b => b.classList.remove('active'));
                dateFrom = document.getElementById('dateFrom').value || null;
                dateTo = document.getElementById('dateTo').value || null;
                updateDateFilterButton();
                document.getElementById('dateDropdown').classList.remove('show');
                applyFilters();
            });

            document.getElementById('clearDate').addEventListener('click', () => {
                dateFrom = null;
                dateTo = null;
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
                document.querySelectorAll('.date-quick-btn').forEach(b => b.classList.remove('active'));
                updateDateFilterButton();
                document.getElementById('dateDropdown').classList.remove('show');
                applyFilters();
            });

            // Project filter - prevent dropdown from closing on inside click
            document.getElementById('projectDropdown').addEventListener('click', (e) => {
                e.stopPropagation();
            });

            document.getElementById('projectFilterBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('projectDropdown').classList.toggle('show');
                document.getElementById('dateDropdown').classList.remove('show');
                document.getElementById('tagDropdown').classList.remove('show');
            });

            // Tag filter - prevent dropdown from closing on inside click
            document.getElementById('tagDropdown').addEventListener('click', (e) => {
                e.stopPropagation();
            });

            document.getElementById('tagFilterBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('tagDropdown').classList.toggle('show');
                document.getElementById('dateDropdown').classList.remove('show');
                document.getElementById('projectDropdown').classList.remove('show');
            });

            // Tag search input
            document.getElementById('tagSearchInput').addEventListener('input', debounce((e) => {
                tagSearchQuery = e.target.value.trim().toLowerCase();
                buildTagFilter();
            }, 200));

            // Clear tag filter button
            document.getElementById('clearTagFilter').addEventListener('click', () => {
                selectedTags = [];
                tagSearchQuery = '';
                document.getElementById('tagSearchInput').value = '';
                updateTagFilterButton();
                document.getElementById('tagDropdown').classList.remove('show');
                buildTagFilter();
                applyFilters();
            });

            // Search scope selector
            document.getElementById('searchScopeSelect').addEventListener('change', (e) => {
                searchScope = e.target.value;
                applyFilters();
            });

            // Close dropdowns on outside click
            document.addEventListener('click', () => {
                document.getElementById('dateDropdown').classList.remove('show');
                document.getElementById('projectDropdown').classList.remove('show');
                document.getElementById('tagDropdown').classList.remove('show');
            });

            // Toggle switches for Tools and Markdown
            document.getElementById('toolCallToggle')?.addEventListener('click', () => {
                const toggle = document.getElementById('toolCallToggle');
                const checkbox = document.getElementById('showToolCalls');
                const conversationContent = document.getElementById('conversationContent');

                toggle.classList.toggle('active');
                checkbox.checked = toggle.classList.contains('active');

                if (checkbox.checked) {
                    conversationContent.classList.remove('hide-tools');
                } else {
                    conversationContent.classList.add('hide-tools');
                }
            });

            document.getElementById('markdownToggle')?.addEventListener('click', () => {
                const toggle = document.getElementById('markdownToggle');
                const checkbox = document.getElementById('renderMarkdown');

                toggle.classList.toggle('active');
                checkbox.checked = toggle.classList.contains('active');
                renderConversation();
            });

            // Tool Call toggle checkbox (legacy)
            document.getElementById('showToolCalls').addEventListener('change', (e) => {
                const conversationContent = document.getElementById('conversationContent');
                if (e.target.checked) {
                    conversationContent.classList.remove('hide-tools');
                } else {
                    conversationContent.classList.add('hide-tools');
                }
            });

            // Markdown rendering toggle checkbox (legacy)
            document.getElementById('renderMarkdown').addEventListener('change', () => {
                renderConversation();
            });

            // Tool Use collapse toggle (event delegation)
            document.getElementById('conversationContent').addEventListener('click', async (e) => {
                // Toggle tool use details
                const toggleBtn = e.target.closest('.tool-use-toggle');
                if (toggleBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    const toolUse = toggleBtn.closest('.tool-use');
                    if (toolUse) {
                        toolUse.classList.toggle('collapsed');
                    }
                    return;
                }

                // Copy message content
                const copyBtn = e.target.closest('.msg-copy-btn');
                if (copyBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    const contentData = copyBtn.getAttribute('data-content');
                    if (contentData) {
                        try {
                            const text = decodeURIComponent(contentData);
                            await navigator.clipboard.writeText(text);
                            copyBtn.classList.add('copied');
                            setTimeout(() => copyBtn.classList.remove('copied'), 1500);
                        } catch (err) {
                            console.error('Failed to copy:', err);
                        }
                    }
                }
            });

            // Conversation search
            let currentSearchIndex = -1;
            let searchMatches = [];

            document.getElementById('conversationSearch').addEventListener('input', debounce((e) => {
                conversationSearchQuery = e.target.value.trim().toLowerCase();
                currentSearchIndex = -1;
                renderConversation();
                // Auto-jump to first match
                if (conversationSearchQuery) {
                    jumpToNextMatch();
                }
            }, 300));

            // Enter key to jump to next match
            document.getElementById('conversationSearch').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (e.shiftKey) {
                        jumpToPrevMatch();
                    } else {
                        jumpToNextMatch();
                    }
                }
            });

            function jumpToNextMatch() {
                searchMatches = document.querySelectorAll('.conversation .message mark');
                if (searchMatches.length === 0) return;

                currentSearchIndex = (currentSearchIndex + 1) % searchMatches.length;
                scrollToMatch(currentSearchIndex);
            }

            function jumpToPrevMatch() {
                searchMatches = document.querySelectorAll('.conversation .message mark');
                if (searchMatches.length === 0) return;

                currentSearchIndex = currentSearchIndex <= 0 ? searchMatches.length - 1 : currentSearchIndex - 1;
                scrollToMatch(currentSearchIndex);
            }

            function scrollToMatch(index) {
                // Remove previous highlight
                document.querySelectorAll('.current-match').forEach(el => el.classList.remove('current-match'));

                const match = searchMatches[index];
                if (match) {
                    match.classList.add('current-match');
                    match.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Update search info
                    const info = document.getElementById('searchResultsInfo');
                    info.textContent = `${index + 1} / ${searchMatches.length} matches (Enter: next, Shift+Enter: prev)`;
                }
            }

            // Resume button - show options menu
            document.getElementById('copyResumeBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleResumeMenu('resumeOptionsMenu');
            });

            // Resume (Skip) button - show options menu
            document.getElementById('copyResumeSkipBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleResumeMenu('resumeSkipOptionsMenu');
            });

            // Toggle resume options menu
            function toggleResumeMenu(menuId) {
                const menu = document.getElementById(menuId);
                const allMenus = document.querySelectorAll('.resume-options-menu');

                // Close other menus
                allMenus.forEach(m => {
                    if (m.id !== menuId) m.classList.remove('show');
                });

                menu.classList.toggle('show');
            }

            // Close menus when clicking outside
            document.addEventListener('click', () => {
                document.querySelectorAll('.resume-options-menu').forEach(m => m.classList.remove('show'));
            });

            // Handle resume options menu clicks
            document.getElementById('resumeOptionsMenu').addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                if (action) {
                    handleResumeAction(action, false);
                    document.getElementById('resumeOptionsMenu').classList.remove('show');
                }
            });

            document.getElementById('resumeSkipOptionsMenu').addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                if (action) {
                    handleResumeAction(action, true);
                    document.getElementById('resumeSkipOptionsMenu').classList.remove('show');
                }
            });

            // Handle resume action
            // action: 'copy', 'terminal', 'iterm2', 'warp', or 'default' (uses settings)
            async function handleResumeAction(action, skipPermissions) {
                const sessionId = document.getElementById('sessionIdDisplay').textContent;
                if (!sessionId || !currentItem) return;

                // Get the project path (add leading slash if not present)
                let projectPath = currentItem.project || '';
                if (projectPath && !projectPath.startsWith('/')) {
                    projectPath = '/' + projectPath;
                }

                // If action is 'default', use the saved default terminal setting
                if (action === 'default') {
                    action = localStorage.getItem('settings-default-terminal') || 'copy';
                }

                if (action === 'copy') {
                    // Copy command to clipboard
                    const skipFlag = skipPermissions ? ' --dangerously-skip-permissions' : '';
                    // Use correct CLI based on current agent
                    const cli = currentAgent === 'opencode' ? 'opencode' : 'claude';
                    const resumeFlag = currentAgent === 'opencode' ? '--resume' : '-r';
                    let command;
                    if (projectPath) {
                        command = `cd "${projectPath}" && ${cli} ${resumeFlag} ${sessionId}${skipFlag}`;
                    } else {
                        command = `${cli} ${resumeFlag} ${sessionId}${skipFlag}`;
                    }

                    try {
                        await navigator.clipboard.writeText(command);

                        // Use the dropdown button for feedback or toast
                        // const btn = document.getElementById(skipPermissions ? 'copyResumeSkipBtn' : 'copyResumeBtn');
                        // Use toast instead
                        showToast('Command copied to clipboard!', 2000);
                        
                    } catch (err) {
                        console.error('Failed to copy:', err);
                        prompt('Copy this command:', command);
                    }
                } else {
                    // Open in selected terminal via API
                    try {
                        const response = await fetch('/api/resume', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: sessionId,
                                project_path: projectPath || '~',
                                skip_permissions: skipPermissions,
                                terminal_app: action  // "terminal", "iterm2", or "warp"
                            })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            alert(`Resume failed: ${error.detail || 'Unknown error'}`);
                            return;
                        }

                        // Success - terminal should now be open
                        console.log(`Opened session in ${action}`);
                        showToast(`Opened in ${action}`, 2000);
                    } catch (error) {
                        alert(`Resume failed: ${error.message}`);
                    }
                }
            }
            // Expose to window for onclick handlers
            window.handleResumeAction = handleResumeAction;

            // Generate Markdown from conversation
            // fullMode: include full tool inputs/outputs without truncation
            function generateMarkdown(fullMode = false) {
                if (!currentItem || !currentMessages.length) return '';

                const sessionName = currentItem.customName || currentItem.preview || 'Untitled Session';
                const projectName = currentItem.project ? currentItem.project.split('/').pop() : 'Unknown Project';

                // Get date info (both start and end include time)
                let dateInfo = '';
                if (currentItem.firstTimestamp) {
                    const firstDate = new Date(currentItem.firstTimestamp);
                    dateInfo = firstDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                }
                if (currentItem.lastTimestamp) {
                    const lastDate = new Date(currentItem.lastTimestamp);
                    const lastDateStr = lastDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    dateInfo += dateInfo ? ` ~ ${lastDateStr}` : lastDateStr;
                }

                // Escape special characters in session name for markdown safety
                const safeSessionName = sessionName.replace(/</g, '&lt;').replace(/>/g, '&gt;');

                let md = `# <font color="#5b9bd5">${safeSessionName}</font>\n\n`;
                md += `**:** ${projectName}  \n`;
                md += `**:** ${dateInfo}  \n`;
                md += `** :** ${currentItem.messageCount || currentMessages.length}  \n`;
                if (currentItem.sessionId) {
                    md += `** ID:** \`${currentItem.sessionId}\`\n`;
                }
                md += '\n---\n';

                // Comprehensive markdown escaping function (defined once, used for all messages)
                function escapeMarkdownContent(text) {
                    let result = text.trim();

                    // 1. CRITICAL: Escape angle brackets (prevents HTML-like tag interpretation)
                    // Example: <session-id> looks like HTML tag and breaks all subsequent parsing
                    result = result.replace(/</g, '&lt;').replace(/>/g, '&gt;');

                    // 2. Handle unbalanced single backticks (unclosed code spans break parsing)
                    // Count backticks that are NOT part of triple backticks
                    const withoutTriple = result.replace(/```/g, '');
                    const singleBacktickCount = (withoutTriple.match(/`/g) || []).length;
                    if (singleBacktickCount % 2 !== 0) {
                        // Odd number - escape all single backticks (not triple)
                        result = result.replace(/`(?!``)/g, '\\`');
                    }

                    // 3. CRITICAL: Handle unbalanced code fences (``` blocks)
                    // If odd number of ```, the last code block is unclosed and will trap all subsequent content
                    const fenceCount = (result.match(/```/g) || []).length;
                    if (fenceCount % 2 !== 0) {
                        // Add closing fence at the end to balance
                        result += '\n```';
                    }

                    // 4. Process line by line for line-start patterns
                    result = result.split('\n').map(line => {
                        const trimmedLine = line.trim();

                        // Don't modify code block markers
                        if (trimmedLine.startsWith('```')) return line;

                        // Escape horizontal rules: --- at start (with optional text after)
                        if (/^-{3,}/.test(trimmedLine)) {
                            return line.replace(/-{3,}/, match => match.split('').map(() => '\\-').join(''));
                        }

                        // Escape horizontal rules: ___ at start
                        if (/^_{3,}/.test(trimmedLine)) {
                            return line.replace(/_{3,}/, match => match.split('').map(() => '\\_').join(''));
                        }

                        // Escape horizontal rules: *** at start
                        if (/^\*{3,}/.test(trimmedLine)) {
                            return line.replace(/\*{3,}/, match => match.split('').map(() => '\\*').join(''));
                        }

                        // Escape headings: # ## ### etc at start of line
                        if (/^#{1,6}(\s|$)/.test(trimmedLine)) {
                            return line.replace(/^(\s*)(#{1,6})/, (match, space, hashes) => {
                                return space + hashes.split('').map(() => '\\#').join('');
                            });
                        }

                        return line;
                    }).join('\n');

                    return result;
                }

                currentMessages.forEach((msg, index) => {
                    const isUser = msg.type === 'user';
                    const role = isUser ? 'User' : 'Claude';

                    // Get timestamp
                    let timeStr = '';
                    if (msg.timestamp) {
                        const msgDate = new Date(msg.timestamp);
                        timeStr = msgDate.toLocaleString('ko-KR', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit'
                        });
                    }

                    // Extract content
                    let content = '';
                    const msgContent = msg.message?.content;
                    let hasToolUse = false;

                    if (typeof msgContent === 'string') {
                        content = msgContent;
                    } else if (Array.isArray(msgContent)) {
                        msgContent.forEach(item => {
                            if (item.type === 'text') {
                                content += item.text + '\n';
                            } else if (item.type === 'tool_use') {
                                // Add tool use indicator (like HTML display)
                                content += `[Tool: ${item.name}]\n`;
                                hasToolUse = true;
                            }
                        });
                    }

                    // Skip empty messages (but keep messages with tool use)
                    if (!content.trim() && !hasToolUse) return;

                    const cleanContent = escapeMarkdownContent(content);

                    // Add message to markdown with proper spacing
                    // Use HTML colored headings for robust rendering (won't break even after code blocks)
                    const userColor = '#4bacc6';    // Cyan/teal for User
                    const claudeColor = '#f79646';  // Orange for Claude
                    const headingColor = isUser ? userColor : claudeColor;
                    md += `\n## <font color="${headingColor}">${role}</font>\n\n`;
                    if (timeStr) {
                        md += `*${timeStr}*\n\n`;
                    }
                    md += cleanContent + '\n\n';

                    // Add tool use info for Claude messages
                    if (!isUser && Array.isArray(msgContent)) {
                        const toolUses = msgContent.filter(item => item.type === 'tool_use');
                        const toolResults = msgContent.filter(item => item.type === 'tool_result');

                        if (toolUses.length > 0) {
                            md += `#### <font color="#9966cc"> </font>\n\n`;
                            toolUses.forEach((tool, idx) => {
                                md += `###### ${tool.name}\n\n`;

                                // Tool Input
                                const inputStr = typeof tool.input === 'string'
                                    ? tool.input
                                    : JSON.stringify(tool.input, null, 2);

                                if (fullMode) {
                                    // Full mode: show complete input
                                    md += '**Input:**\n```json\n' + inputStr + '\n```\n\n';

                                    // Find matching tool result by tool_use_id
                                    const result = toolResults.find(r => r.tool_use_id === tool.id);
                                    if (result) {
                                        let resultContent = '';
                                        if (typeof result.content === 'string') {
                                            resultContent = result.content;
                                        } else if (Array.isArray(result.content)) {
                                            result.content.forEach(item => {
                                                if (item.type === 'text') {
                                                    resultContent += item.text + '\n';
                                                }
                                            });
                                        }
                                        if (resultContent.trim()) {
                                            // Escape the result content for markdown safety
                                            const safeResult = escapeMarkdownContent(resultContent.trim());
                                            md += '**Output:**\n```\n' + safeResult + '\n```\n\n';
                                        }
                                    }
                                } else {
                                    // Normal mode: truncate input, no output
                                    const displayInput = inputStr.length > 500 ? inputStr.substring(0, 500) + '...' : inputStr;
                                    md += '```json\n' + displayInput + '\n```\n\n';
                                }
                            });
                        }
                    }

                    md += '\n---\n';
                });

                return md;
            }

            // Helper function for clipboard copy with fallbacks
            async function copyToClipboard(text, btnId, originalLabel) {
                const btn = document.getElementById(btnId);

                // Method 1: Modern Clipboard API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    try {
                        await navigator.clipboard.writeText(text);
                        showToast('Copied to clipboard!', 2000);
                        
                        if (btn && btn.querySelector('span')) {
                            btn.classList.add('copied');
                            btn.querySelector('span').textContent = 'Copied!';
                            setTimeout(() => {
                                btn.classList.remove('copied');
                                btn.querySelector('span').textContent = originalLabel;
                            }, 2000);
                        }
                        return true;
                    } catch (err) {
                        console.log('Clipboard API failed, trying execCommand:', err);
                    }
                }

                // Method 2: execCommand fallback (works in more contexts)
                try {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.cssText = 'position:fixed;top:0;left:0;width:1px;height:1px;opacity:0;';
                    document.body.appendChild(textarea);
                    textarea.focus();
                    textarea.select();

                    const success = document.execCommand('copy');
                    document.body.removeChild(textarea);

                    if (success) {
                        showToast('Copied to clipboard!', 2000);
                        
                        if (btn && btn.querySelector('span')) {
                            btn.classList.add('copied');
                            btn.querySelector('span').textContent = 'Copied!';
                            setTimeout(() => {
                                btn.classList.remove('copied');
                                btn.querySelector('span').textContent = originalLabel;
                            }, 2000);
                        }
                        return true;
                    }
                } catch (err) {
                    console.log('execCommand failed:', err);
                }

                // Method 3: Show copy modal for manual copy
                showCopyModal(text);
                return false;
            }

            // Copy modal for manual copy when APIs fail
            function showCopyModal(text) {
                // Remove existing modal if any
                const existingModal = document.getElementById('copyModal');
                if (existingModal) existingModal.remove();

                const modal = document.createElement('div');
                modal.id = 'copyModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.8);
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;

                const container = document.createElement('div');
                container.style.cssText = `
                    background: var(--bg);
                    border-radius: 12px;
                    padding: 20px;
                    max-width: 90%;
                    max-height: 80%;
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                `;

                const header = document.createElement('div');
                header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;';
                header.innerHTML = `
                    <span style="font-weight:600;color:var(--text);">   </span>
                    <button id="closeCopyModal" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted);">&times;</button>
                `;

                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.readOnly = true;
                textarea.style.cssText = `
                    width: 100%;
                    min-width: 300px;
                    height: 300px;
                    padding: 12px;
                    border: 1px solid var(--border);
                    border-radius: 8px;
                    font-family: monospace;
                    font-size: 12px;
                    resize: none;
                    background: var(--bg-secondary);
                    color: var(--text);
                `;

                const hint = document.createElement('div');
                hint.style.cssText = 'color:var(--text-muted);font-size:12px;text-align:center;';
                hint.textContent = 'iOS:      | Desktop: Ctrl+A  Ctrl+C';

                container.appendChild(header);
                container.appendChild(textarea);
                container.appendChild(hint);
                modal.appendChild(container);
                document.body.appendChild(modal);

                // Auto-select text
                setTimeout(() => {
                    textarea.focus();
                    textarea.select();
                }, 100);

                // Close handlers
                document.getElementById('closeCopyModal').addEventListener('click', () => modal.remove());
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            }

            // Copy MD button
            document.getElementById('copyMdBtn').addEventListener('click', async () => {
                const markdown = generateMarkdown();
                if (!markdown) return;
                await copyToClipboard(markdown, 'copyMdBtn', 'Copy MD');
            });

            // Helper function for file download via server API
            async function downloadFile(content, filename, btnId, originalLabel) {
                const btn = document.getElementById(btnId);

                try {
                    const response = await fetch('/api/download', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content, filename })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    // Get blob and create object URL
                    const blob = await response.blob();

                    // Use createObjectURL + click approach
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();

                    // Cleanup after a delay
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    }, 1000);

                    btn.classList.add('copied');
                    btn.querySelector('span').textContent = 'Saved!';
                    setTimeout(() => {
                        btn.classList.remove('copied');
                        btn.querySelector('span').textContent = originalLabel;
                    }, 2000);
                } catch (err) {
                    console.error('Download error:', err);
                    // Fallback: show modal
                    showSaveModal(content, filename);
                }
            }

            // Save modal for manual save when download fails
            function showSaveModal(content, filename) {
                const existingModal = document.getElementById('saveModal');
                if (existingModal) existingModal.remove();

                const modal = document.createElement('div');
                modal.id = 'saveModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.8);
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;

                const container = document.createElement('div');
                container.style.cssText = `
                    background: var(--bg);
                    border-radius: 12px;
                    padding: 20px;
                    max-width: 90%;
                    max-height: 80%;
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                `;

                const header = document.createElement('div');
                header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;';
                header.innerHTML = `
                    <span style="font-weight:600;color:var(--text);">: ${filename}</span>
                    <button id="closeSaveModal" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted);">&times;</button>
                `;

                const textarea = document.createElement('textarea');
                textarea.value = content;
                textarea.readOnly = true;
                textarea.style.cssText = `
                    width: 100%;
                    min-width: 300px;
                    height: 300px;
                    padding: 12px;
                    border: 1px solid var(--border);
                    border-radius: 8px;
                    font-family: monospace;
                    font-size: 12px;
                    resize: none;
                    background: var(--bg-secondary);
                    color: var(--text);
                `;

                const hint = document.createElement('div');
                hint.style.cssText = 'color:var(--text-muted);font-size:12px;text-align:center;';
                hint.textContent = '     ';

                container.appendChild(header);
                container.appendChild(textarea);
                container.appendChild(hint);
                modal.appendChild(container);
                document.body.appendChild(modal);

                setTimeout(() => {
                    textarea.focus();
                    textarea.select();
                }, 100);

                document.getElementById('closeSaveModal').addEventListener('click', () => modal.remove());
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            }

            // Save MD button
            document.getElementById('saveMdBtn').addEventListener('click', async () => {
                const markdown = generateMarkdown();
                if (!markdown) return;

                const sessionName = currentItem.customName || currentItem.preview || 'conversation';
                const cleanName = sessionName.replace(/[<>:"/\\|?*]/g, '').substring(0, 50).trim();
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `${cleanName}_${timestamp}.md`;

                await downloadFile(markdown, filename, 'saveMdBtn', 'Save MD');
            });

            // Copy MD Full button (with full tool details)
            document.getElementById('copyMdFullBtn').addEventListener('click', async () => {
                const markdown = generateMarkdown(true); // fullMode = true
                if (!markdown) return;
                await copyToClipboard(markdown, 'copyMdFullBtn', 'Copy Full');
            });

            // Save MD Full button (with full tool details)
            document.getElementById('saveMdFullBtn').addEventListener('click', async () => {
                const markdown = generateMarkdown(true); // fullMode = true
                if (!markdown) return;

                const sessionName = currentItem.customName || currentItem.preview || 'conversation';
                const cleanName = sessionName.replace(/[<>:"/\\|?*]/g, '').substring(0, 50).trim();
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `${cleanName}_full_${timestamp}.md`;

                await downloadFile(markdown, filename, 'saveMdFullBtn', 'Save Full');
            });

            // Refresh index button - via API
            document.getElementById('refreshIndexBtn').addEventListener('click', async () => {
                const btn = document.getElementById('refreshIndexBtn');
                btn.classList.add('loading');
                btn.disabled = true;

                try {
                    const response = await fetch('/api/update-index', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        alert(`  : ${error.detail || '   '}`);
                        return;
                    }

                    // Reload session index
                    await loadSessionIndex();
                    await loadSessionTags();
                    buildTagFilter();

                    console.log('Index updated successfully');
                } catch (error) {
                    alert(`  : ${error.message}`);
                } finally {
                    btn.classList.remove('loading');
                    btn.disabled = false;
                }
            });

            // Auto-refresh: Update index and check for new sessions
            // Uses configurable interval from settings (0 = disabled)
            let autoRefreshIntervalId = null;
            
            function startAutoRefresh() {
                // Clear existing interval if any
                if (autoRefreshIntervalId) {
                    clearInterval(autoRefreshIntervalId);
                    autoRefreshIntervalId = null;
                }
                
                // Get interval from settings (in seconds), default 60
                const intervalSeconds = parseInt(localStorage.getItem('settings-auto-refresh') || '60');
                
                // 0 means disabled
                if (intervalSeconds <= 0) {
                    console.log('Auto-refresh disabled');
                    return;
                }
                
                const intervalMs = intervalSeconds * 1000;
                console.log(`Auto-refresh enabled: every ${intervalSeconds}s`);
                
                autoRefreshIntervalId = setInterval(async () => {
                    try {
                        // First, update the index to detect new sessions
                        await fetch('/api/update-index', { method: 'POST' });

                        // Then reload data
                        const prevCount = allItems.length;
                        await loadSessionIndex();
                        await loadSessionTags();

                        const newCount = allItems.length;
                        if (newCount !== prevCount) {
                            console.log(`Auto-refresh: ${prevCount}  ${newCount} sessions`);
                            buildTagFilter();
                        }
                    } catch (err) {
                        console.log('Auto-refresh failed:', err.message);
                    }
                }, intervalMs);
            }
            
            // Start auto-refresh on load
            startAutoRefresh();

            // Rename session button - opens modal
            document.getElementById('renameSessionBtn').addEventListener('click', () => {
                if (!currentItem || currentItem.type !== 'session') return;
                openRenameModal(currentItem.sessionId);
            });

            // Edit title button - opens same modal
            document.getElementById('editTitleBtn').addEventListener('click', () => {
                if (!currentItem || currentItem.type !== 'session') return;
                openRenameModal(currentItem.sessionId);
            });

            // Delete session button - via API
            document.getElementById('deleteSessionBtn').addEventListener('click', async () => {
                if (!currentItem || currentItem.type !== 'session') return;

                const sessionId = currentItem.sessionId;
                const projectFolder = currentItem.projectFolder;
                const fileName = currentItem.fileName;

                // Confirm before deleting
                const confirmed = confirm(
                    `Delete this session?\n\n` +
                    `Session: ${sessionId}\n` +
                    `File: ${fileName}\n\n` +
                    `This action cannot be undone.`
                );

                if (!confirmed) return;

                try {
                    const response = await fetch('/api/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: sessionId,
                            project_folder: projectFolder,
                            file_name: fileName
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        alert(` : ${error.detail || '   '}`);
                        return;
                    }

                    const result = await response.json();

                    // Remove from local data
                    const index = allItems.findIndex(i => i.sessionId === sessionId);
                    if (index !== -1) {
                        allItems.splice(index, 1);
                    }

                    // Remove from sessionTags
                    delete sessionTags[sessionId];

                    // Update tag filter dropdown
                    buildTagFilter();

                    // Clear detail view and refresh list
                    currentItem = null;
                    document.getElementById('conversationView').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'flex';
                    applyFilters();

                    console.log(`Deleted session: ${sessionId}`);
                } catch (error) {
                    alert(` : ${error.message}`);
                }
            });

            // ===== MOBILE EVENT HANDLERS =====

            // Mobile menu button (FAB)
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const sidebar = document.querySelector('.sidebar');

            function toggleMobileMenu() {
                const isOpen = sidebar.classList.toggle('open');
                mobileMenuBtn.classList.toggle('active', isOpen);
                mobileOverlay.classList.toggle('show', isOpen);
                document.body.style.overflow = isOpen ? 'hidden' : '';
            }

            function closeMobileMenu() {
                sidebar.classList.remove('open');
                mobileMenuBtn.classList.remove('active');
                mobileOverlay.classList.remove('show');
                document.body.style.overflow = '';
            }

            mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            mobileOverlay.addEventListener('click', closeMobileMenu);

            // Close sidebar when a session is selected (on mobile)
            document.getElementById('sessionList').addEventListener('click', (e) => {
                const sessionItem = e.target.closest('.session-item');
                if (sessionItem && window.innerWidth <= 900) {
                    setTimeout(closeMobileMenu, 100);
                }
            });

            // Mobile actions menu
            const mobileActionsBtn = document.getElementById('mobileActionsBtn');
            const mobileActionsMenu = document.getElementById('mobileActionsMenu');
            const mobileActionsClose = document.getElementById('mobileActionsClose');

            function showMobileActionsMenu() {
                mobileActionsMenu.style.display = 'block';
                mobileOverlay.classList.add('show');
                document.body.style.overflow = 'hidden';
                // Force reflow for animation
                mobileActionsMenu.offsetHeight;
                mobileActionsMenu.classList.add('show');
            }

            function hideMobileActionsMenu() {
                mobileActionsMenu.classList.remove('show');
                if (!sidebar.classList.contains('open')) {
                    mobileOverlay.classList.remove('show');
                    document.body.style.overflow = '';
                }
                setTimeout(() => {
                    if (!mobileActionsMenu.classList.contains('show')) {
                        mobileActionsMenu.style.display = 'none';
                    }
                }, 300);
            }

            // Use both click and touchend for better mobile response
            mobileActionsBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showMobileActionsMenu();
            });
            mobileActionsBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showMobileActionsMenu();
            }, { passive: false });

            mobileActionsClose.addEventListener('click', hideMobileActionsMenu);
            mobileActionsClose.addEventListener('touchend', (e) => {
                e.preventDefault();
                hideMobileActionsMenu();
            }, { passive: false });

            // Close actions menu when overlay is clicked (if sidebar is not open)
            mobileOverlay.addEventListener('click', () => {
                if (mobileActionsMenu.classList.contains('show')) {
                    hideMobileActionsMenu();
                }
            });

            // Mobile action buttons - delegate to desktop buttons with touch support
            function addMobileActionHandler(mobileId, desktopId, needsDelay = false) {
                const mobileBtn = document.getElementById(mobileId);
                const handler = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    hideMobileActionsMenu();
                    if (needsDelay) {
                        setTimeout(() => {
                            document.getElementById(desktopId).click();
                        }, 300);
                    } else {
                        document.getElementById(desktopId).click();
                    }
                };
                mobileBtn.addEventListener('click', handler);
                mobileBtn.addEventListener('touchend', handler, { passive: false });
            }

            // Mobile Resume handlers - directly copy command and show toast
            function handleMobileResume(skipPermissions) {
                return async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    hideMobileActionsMenu();

                    const sessionId = document.getElementById('sessionIdDisplay')?.textContent;
                    if (!sessionId || !currentItem) return;

                    let projectPath = currentItem.project || '';
                    if (projectPath && !projectPath.startsWith('/')) {
                        projectPath = '/' + projectPath;
                    }

                    const skipFlag = skipPermissions ? ' --dangerously-skip-permissions' : '';
                    // Use correct CLI based on current agent
                    const cli = currentAgent === 'opencode' ? 'opencode' : 'claude';
                    const resumeFlag = currentAgent === 'opencode' ? '--resume' : '-r';
                    const command = projectPath
                        ? `cd "${projectPath}" && ${cli} ${resumeFlag} ${sessionId}${skipFlag}`
                        : `${cli} ${resumeFlag} ${sessionId}${skipFlag}`;

                    try {
                        await copyToClipboardMobile(command);
                        showToast(' ');
                    } catch (err) {
                        console.error('Failed to copy:', err);
                        showToast(' ');
                    }
                };
            }

            // Clipboard copy with fallback for mobile
            async function copyToClipboardMobile(text) {
                // Try modern API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    try {
                        await navigator.clipboard.writeText(text);
                        return;
                    } catch (e) {
                        // Fall through to fallback
                    }
                }

                // Fallback: create temporary textarea
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                textarea.style.top = '0';
                textarea.setAttribute('readonly', '');
                document.body.appendChild(textarea);

                // Select and copy
                textarea.focus();
                textarea.select();
                textarea.setSelectionRange(0, text.length);

                const success = document.execCommand('copy');
                document.body.removeChild(textarea);

                if (!success) {
                    throw new Error('execCommand copy failed');
                }
            }

            // Toast function
            function showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 2000);
            }

            const mobileResumeHandler = handleMobileResume(false);
            const mobileResumeSkipHandler = handleMobileResume(true);

            document.getElementById('mobileResumeBtn').addEventListener('click', mobileResumeHandler);
            document.getElementById('mobileResumeBtn').addEventListener('touchend', mobileResumeHandler, { passive: false });
            document.getElementById('mobileResumeSkipBtn').addEventListener('click', mobileResumeSkipHandler);
            document.getElementById('mobileResumeSkipBtn').addEventListener('touchend', mobileResumeSkipHandler, { passive: false });

            addMobileActionHandler('mobileRenameBtn', 'renameSessionBtn', true);
            addMobileActionHandler('mobileCopyMdBtn', 'copyMdBtn');
            addMobileActionHandler('mobileSaveMdBtn', 'saveMdBtn');
            addMobileActionHandler('mobileDeleteBtn', 'deleteSessionBtn', true);

            // Handle escape key for mobile menus
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (mobileActionsMenu.classList.contains('show')) {
                        hideMobileActionsMenu();
                    } else if (sidebar.classList.contains('open')) {
                        closeMobileMenu();
                    }
                }
            });

            // Handle window resize - close mobile menu if switching to desktop
            window.addEventListener('resize', () => {
                if (window.innerWidth > 900) {
                    closeMobileMenu();
                    hideMobileActionsMenu();
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
            document.getElementById('sidebarToggleBtn')?.addEventListener('click', toggleLeftSidebar);
            document.getElementById('rightSidebarClose')?.addEventListener('click', () => toggleRightSidebar(false));
            document.getElementById('shortcutsModalClose')?.addEventListener('click', () => toggleShortcutsModal(false));
            document.getElementById('shortcutsModal')?.addEventListener('click', (e) => {
                if (e.target.id === 'shortcutsModal') toggleShortcutsModal(false);
            });

            // Settings modal
            document.getElementById('settingsModalClose')?.addEventListener('click', () => toggleSettingsModal(false));
            document.getElementById('settingsModal')?.addEventListener('click', (e) => {
                if (e.target.id === 'settingsModal') toggleSettingsModal(false);
            });
            document.getElementById('settingsSave')?.addEventListener('click', saveSettings);
            document.getElementById('settingsReset')?.addEventListener('click', resetSettings);
            document.getElementById('settingsShowTools')?.addEventListener('click', function() {
                this.classList.toggle('active');
            });
            document.getElementById('settingsRenderMd')?.addEventListener('click', function() {
                this.classList.toggle('active');
            });

            // Quick actions in right sidebar
            document.getElementById('qaResume')?.addEventListener('click', () => {
                if (currentItem) document.getElementById('copyResumeBtn')?.click();
            });
            document.getElementById('qaCopyMd')?.addEventListener('click', () => {
                if (currentItem) document.getElementById('copyMdBtn')?.click();
            });
            document.getElementById('qaRename')?.addEventListener('click', () => {
                if (currentItem) document.getElementById('renameSessionBtn')?.click();
            });
        }

        function formatDateValue(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function updateDateFilterButton() {
            const btn = document.getElementById('dateFilterBtn');
            if (dateFrom || dateTo) {
                let text = '';
                if (dateFrom && dateTo) {
                    text = `${formatShortDate(dateFrom)} - ${formatShortDate(dateTo)}`;
                } else if (dateFrom) {
                    text = `From ${formatShortDate(dateFrom)}`;
                } else {
                    text = `Until ${formatShortDate(dateTo)}`;
                }
                btn.querySelector('span').textContent = text;
                btn.classList.add('active');
            } else {
                btn.querySelector('span').textContent = 'All Dates';
                btn.classList.remove('active');
            }
        }

        function buildProjectFilter() {
            const projects = {};
            allItems.forEach(item => {
                const p = item.project || 'Unknown';
                projects[p] = (projects[p] || 0) + 1;
            });

            const dropdown = document.getElementById('projectDropdown');
            dropdown.innerHTML = `
                <div class="project-option ${!selectedProject ? 'selected' : ''}" data-project="">
                    <span>All Projects</span>
                    <span class="project-count">${allItems.length}</span>
                </div>
            `;

            Object.entries(projects)
                .sort((a, b) => b[1] - a[1])
                .forEach(([project, count]) => {
                    const name = project.split('/').pop() || project;
                    const el = document.createElement('div');
                    el.className = `project-option ${selectedProject === project ? 'selected' : ''}`;
                    el.dataset.project = project;
                    el.innerHTML = `
                        <span title="${project}">${name}</span>
                        <span class="project-count">${count}</span>
                    `;
                    el.addEventListener('click', () => selectProject(project));
                    dropdown.appendChild(el);
                });

            dropdown.querySelector('[data-project=""]').addEventListener('click', () => selectProject(null));
        }

        function selectProject(project) {
            selectedProject = project;
            const btn = document.getElementById('projectFilterBtn');
            const name = project ? project.split('/').pop() : 'All Projects';
            btn.querySelector('span').textContent = name;
            btn.classList.toggle('active', !!project);
            document.getElementById('projectDropdown').classList.remove('show');
            buildProjectFilter();
            applyFilters();
        }

        function buildTagFilter() {
            const tagCounts = getAllTags();
            const dropdown = document.getElementById('tagOptionsList');

            // Filter tags by search query
            let filteredTags = Object.entries(tagCounts);
            if (tagSearchQuery) {
                filteredTags = filteredTags.filter(([tag]) =>
                    tag.toLowerCase().includes(tagSearchQuery)
                );
            }

            // Sort by count (descending), then by name
            filteredTags.sort((a, b) => {
                if (b[1] !== a[1]) return b[1] - a[1];
                return a[0].localeCompare(b[0]);
            });

            if (filteredTags.length === 0) {
                dropdown.innerHTML = '<div style="padding: 12px; color: var(--text-muted); text-align: center;">No tags found</div>';
                return;
            }

            dropdown.innerHTML = filteredTags.map(([tag, count]) => `
                <label class="tag-option">
                    <input type="checkbox" value="${escapeHtml(tag)}" ${selectedTags.includes(tag) ? 'checked' : ''}>
                    <span class="tag-option-label ${tag === 'named' ? 'named-tag' : ''}">${escapeHtml(tag)}</span>
                    <span class="tag-option-count">${count}</span>
                </label>
            `).join('');

            // Add event listeners to checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const tag = e.target.value;
                    if (e.target.checked) {
                        if (!selectedTags.includes(tag)) {
                            selectedTags.push(tag);
                        }
                    } else {
                        selectedTags = selectedTags.filter(t => t !== tag);
                    }
                    updateTagFilterButton();
                    applyFilters();
                });
            });
        }

        function updateTagFilterButton() {
            const btn = document.getElementById('tagFilterBtn');
            if (selectedTags.length === 0) {
                btn.querySelector('span').textContent = 'All Tags';
                btn.classList.remove('active');
            } else if (selectedTags.length === 1) {
                btn.querySelector('span').textContent = selectedTags[0];
                btn.classList.add('active');
            } else {
                btn.querySelector('span').textContent = `${selectedTags.length} tags`;
                btn.classList.add('active');
            }
        }

        // Update description via API
        async function updateSessionDescription(sessionId, description) {
            try {
                const response = await fetch('/api/description', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, description: description })
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(`  : ${error.detail || '   '}`);
                    return false;
                }

                const result = await response.json();

                // Update local sessionDescriptions
                if (result.action === 'removed') {
                    delete sessionDescriptions[sessionId];
                } else {
                    sessionDescriptions[sessionId] = result.description;
                }

                // Refresh UI
                renderHeaderDescription();
                applyFilters();  // Refresh session list

                return true;
            } catch (error) {
                alert(`  : ${error.message}`);
                return false;
            }
        }

        function promptEditDescription(sessionId) {
            openRenameModal(sessionId);
        }

        // Render header description for current session
        function renderHeaderDescription() {
            const container = document.getElementById('headerDescriptionRow');
            if (!currentItem || currentItem.type !== 'session') {
                container.style.display = 'none';
                return;
            }

            const description = getSessionDescription(currentItem.sessionId);
            const sessionId = currentItem.sessionId;

            if (description) {
                container.innerHTML = `
                    <div class="header-description-content">${escapeHtml(description).replace(/\n/g, '<br>')}</div>
                    <button class="edit-description-btn" id="editDescriptionBtn" title=" ">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                `;
            } else {
                container.innerHTML = `
                    <div class="header-description-placeholder" id="addDescriptionPlaceholder">+  ...</div>
                `;
            }

            container.style.display = 'flex';

            // Attach event listeners
            const editBtn = document.getElementById('editDescriptionBtn');
            if (editBtn) {
                editBtn.addEventListener('click', () => promptEditDescription(sessionId));
            }

            const placeholder = document.getElementById('addDescriptionPlaceholder');
            if (placeholder) {
                placeholder.addEventListener('click', () => promptEditDescription(sessionId));
            }
        }

        // Render header tags for current session
        function renderHeaderTags() {
            const container = document.getElementById('headerTagsRow');
            if (!currentItem || currentItem.type !== 'session') {
                container.style.display = 'none';
                return;
            }

            const tags = getSessionTags(currentItem.sessionId, currentItem.customName);

            let html = tags.map(tag => `
                <span class="header-tag ${tag === 'named' ? 'named-tag' : ''}" data-tag="${escapeHtml(tag)}">
                    ${escapeHtml(tag)}
                    ${tag !== 'named' ? '<span class="tag-remove" title="Remove tag">&times;</span>' : ''}
                </span>
            `).join('');

            html += `
                <button class="add-tag-btn" id="addTagBtn">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Add Tag
                </button>
            `;

            container.innerHTML = html;
            container.style.display = 'flex';

            // Add event listeners
            container.querySelectorAll('.tag-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const tag = e.target.closest('.header-tag').dataset.tag;
                    removeTagFromSession(currentItem.sessionId, tag);
                });
            });

            const addBtn = document.getElementById('addTagBtn');
            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    openTagModal(currentItem.sessionId);
                });
            }
        }

        function applyFilters() {
            filteredItems = allItems.filter(item => {
                // Type filter
                if (showType === 'sessions' && item.type !== 'session') return false;
                if (showType === 'history' && item.type !== 'history') return false;

                // Get tags for this item
                const itemTags = item.type === 'session'
                    ? getSessionTags(item.sessionId, item.customName)
                    : [];
                const itemTagsLower = itemTags.map(t => t.toLowerCase());

                // Tag filter - session must have ALL selected tags
                if (selectedTags.length > 0) {
                    if (item.type !== 'session') return false;
                    const hasAllTags = selectedTags.every(tag =>
                        itemTags.includes(tag)
                    );
                    if (!hasAllTags) return false;
                }

                // Search filter - based on search scope
                if (searchQuery) {
                    const customName = (item.customName || '').toLowerCase();
                    const preview = (item.preview || item.display || '').toLowerCase();
                    const project = (item.project || '').toLowerCase();
                    const searchableContent = (item.searchableContent || '').toLowerCase();
                    const description = item.type === 'session'
                        ? getSessionDescription(item.sessionId).toLowerCase()
                        : '';

                    let matchFound = false;

                    switch (searchScope) {
                        case 'title':
                            // Title = customName + preview (first message)
                            matchFound = customName.includes(searchQuery) ||
                                         preview.includes(searchQuery);
                            break;
                        case 'content':
                            // Content only (full conversation text)
                            matchFound = searchableContent.includes(searchQuery);
                            break;
                        case 'title_content':
                            // Title + Content
                            matchFound = customName.includes(searchQuery) ||
                                         preview.includes(searchQuery) ||
                                         searchableContent.includes(searchQuery);
                            break;
                        case 'tags':
                            // Tags only
                            matchFound = itemTagsLower.some(t => t.includes(searchQuery));
                            break;
                        case 'description':
                            // Description only
                            matchFound = description.includes(searchQuery);
                            break;
                        case 'all':
                        default:
                            // All: Title + Content + Tags + Description + Project
                            matchFound = customName.includes(searchQuery) ||
                                         preview.includes(searchQuery) ||
                                         project.includes(searchQuery) ||
                                         searchableContent.includes(searchQuery) ||
                                         description.includes(searchQuery) ||
                                         itemTagsLower.some(t => t.includes(searchQuery));
                            break;
                    }

                    if (!matchFound) {
                        return false;
                    }
                }

                // Project filter
                if (selectedProject && item.project !== selectedProject) {
                    return false;
                }

                // Date filter
                if (dateFrom || dateTo) {
                    let itemDate;
                    if (item.type === 'session') {
                        itemDate = item.lastTimestamp ? new Date(item.lastTimestamp) : new Date(item.modifiedTime * 1000);
                    } else {
                        itemDate = item.timestampISO ? new Date(item.timestampISO) : new Date(item.timestamp);
                    }

                    if (dateFrom) {
                        const from = new Date(dateFrom);
                        from.setHours(0, 0, 0, 0);
                        if (itemDate < from) return false;
                    }

                    if (dateTo) {
                        const to = new Date(dateTo);
                        to.setHours(23, 59, 59, 999);
                        if (itemDate > to) return false;
                    }
                }

                return true;
            });

            document.getElementById('filteredCount').textContent = filteredItems.length;
            
            // Show/hide filtered stats row based on active filters
            const hasActiveFilters = searchQuery || selectedProject || selectedTags.length > 0 || dateFrom || dateTo;
            const filteredRow = document.getElementById('statsFiltered');
            if (hasActiveFilters && filteredItems.length !== allItems.length) {
                filteredRow.style.display = 'flex';
            } else {
                filteredRow.style.display = 'none';
            }
            
            renderSessionList();
        }

        function renderSessionList() {
            const container = document.getElementById('sessionList');

            if (filteredItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-title">No items found</div>
                        <p>Try adjusting your filters</p>
                    </div>
                `;
                return;
            }

            // Group by date
            const groups = {};
            filteredItems.forEach(item => {
                let date;
                if (item.type === 'session') {
                    date = item.lastTimestamp
                        ? new Date(item.lastTimestamp)
                        : new Date(item.modifiedTime * 1000);
                } else {
                    date = item.timestampISO ? new Date(item.timestampISO) : new Date(item.timestamp);
                }
                const dateKey = formatDate(date);
                if (!groups[dateKey]) groups[dateKey] = [];
                groups[dateKey].push(item);
            });

            let html = '';
            Object.entries(groups).forEach(([date, items]) => {
                html += `<div class="session-group">`;
                html += `<div class="session-group-header">${date} (${items.length})</div>`;

                items.forEach(item => {
                    const isSession = item.type === 'session';
                    let time;
                    if (isSession) {
                        time = item.lastTimestamp
                            ? formatTime(new Date(item.lastTimestamp))
                            : formatTime(new Date(item.modifiedTime * 1000));
                    } else {
                        time = item.timestampISO
                            ? formatTime(new Date(item.timestampISO))
                            : formatTime(new Date(item.timestamp));
                    }

                    const projectName = item.project ? item.project.split('/').pop() : '';
                    const preview = highlightSearch(escapeHtml(item.preview || item.display || 'No preview'), searchQuery);
                    const itemId = isSession ? item.sessionId : item.historyId;
                    const isActive = currentItem && (currentItem.sessionId === itemId || currentItem.historyId === itemId);
                    const customName = item.customName ? escapeHtml(item.customName) : null;

                    if (isSession) {
                        // Get tags for this session (excluding 'named' since we show it separately)
                        const itemTags = getSessionTags(item.sessionId, item.customName).filter(t => t !== 'named');
                        
                        // Use relative time for session list
                        const relativeTime = item.lastTimestamp 
                            ? formatRelativeTime(new Date(item.lastTimestamp))
                            : (item.modifiedTime ? formatRelativeTime(new Date(item.modifiedTime * 1000)) : time);

                        const tagsListHtml = itemTags.length > 0
                            ? `<div class="session-tags-list" style="margin-top:6px;">${itemTags.map(t => `<span class="mini-pill">${escapeHtml(t)}</span>`).join('')}</div>`
                            : '';

                        // Get description for this session
                        const itemDescription = getSessionDescription(item.sessionId);
                        const descriptionHtml = itemDescription
                            ? `<div class="session-description" style="margin-top:6px;">${highlightSearch(escapeHtml(itemDescription), searchQuery)}</div>`
                            : '';

                        html += `
                            <div class="session-item ${isActive ? 'active' : ''}" data-type="session" data-session-id="${item.sessionId}" data-project-folder="${item.projectFolder || ''}" data-file-name="${item.fileName || ''}" data-agent="${item.agent || 'claude'}">
                                <div class="session-icon" style="display:none;">
                                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:20px;height:20px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                                </div>
                                <div class="session-content-wrapper">
                                    <div class="session-preview" style="${customName ? 'font-weight:700; color:var(--text-primary);' : ''}">
                                        ${customName || preview}
                                    </div>
                                    
                                    <div class="session-meta-row">
                                        ${isSessionActive(item) ? '<span class="active-badge"> Active</span>' : ''}
                                        <span class="session-time">${relativeTime}</span>
                                        <span class="session-time" style="opacity:0.5"></span>
                                        <span class="session-time">${item.messageCount || 0} msgs</span>
                                        ${projectName ? `<span class="session-project" style="margin-top:0; margin-left:auto;">${projectName}</span>` : ''}
                                    </div>
                                    
                                    ${tagsListHtml}
                                    ${descriptionHtml}
                                </div>
                            </div>
                        `;
                    } else {
                        // History-only entry
                        html += `
                            <div class="session-item history-only ${isActive ? 'active' : ''}" data-type="history" data-history-id="${item.historyId}" data-display="${escapeHtml(item.display || '')}" data-timestamp="${item.timestampISO || ''}">
                                <div class="session-icon" style="display:none;">
                                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:20px;height:20px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </div>
                                <div class="session-content-wrapper">
                                    <div class="session-item-header">
                                        <span class="session-time">${time}</span>
                                        <span class="session-messages history-badge">history only</span>
                                    </div>
                                    <div class="session-preview">${preview}</div>
                                    ${projectName ? `<div class="session-project">
                                        <svg width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                                        </svg>
                                        ${projectName}
                                    </div>` : ''}
                                </div>
                            </div>
                        `;
                    }
                });

                html += `</div>`;
            });

            container.innerHTML = html;

            // Add click handlers
            container.querySelectorAll('.session-item').forEach(el => {
                el.addEventListener('click', () => {
                    const type = el.dataset.type;
                    if (type === 'session') {
                        const sessionId = el.dataset.sessionId;
                        const projectFolder = el.dataset.projectFolder;
                        const fileName = el.dataset.fileName;
                        const agent = el.dataset.agent || 'claude';
                        loadSession(sessionId, projectFolder, fileName, agent);
                    } else {
                        const historyId = el.dataset.historyId;
                        const display = el.dataset.display;
                        const timestamp = el.dataset.timestamp;
                        showHistoryEntry(historyId, display, timestamp);
                    }
                });
            });
        }

        async function loadSession(sessionId, projectFolder, fileName, agent = 'claude') {
            // Update UI
            document.querySelectorAll('.session-item').forEach(el => {
                el.classList.toggle('active', el.dataset.sessionId === sessionId);
            });

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('conversationView').style.display = 'flex';
            document.getElementById('conversationContent').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            `;

            try {
                currentMessages = [];

                if (agent === 'opencode') {
                    // Load OpenCode session from API
                    const response = await fetch(`/api/opencode/session/${sessionId}/content?t=${Date.now()}`);
                    if (!response.ok) {
                        throw new Error(`Failed to load OpenCode session: ${response.status}`);
                    }
                    const messages = await response.json();

                    // Transform OpenCode messages to common format
                    for (const msg of messages) {
                        if (msg.type === 'user' || msg.type === 'assistant') {
                            currentMessages.push({
                                type: msg.type,
                                message: {
                                    id: msg.message?.id,
                                    role: msg.message?.role || msg.type,
                                    content: msg.message?.content || [],
                                    model: msg.message?.model
                                },
                                timestamp: msg.timestamp
                            });
                        }
                    }
                } else {
                    // Load Claude Code session from JSONL file
                    const response = await fetch(`projects/${projectFolder}/${fileName}`);
                    const text = await response.text();

                    const lines = text.trim().split('\n');
                    for (const line of lines) {
                        try {
                            const data = JSON.parse(line);
                            if (data.type === 'user' || data.type === 'assistant') {
                                currentMessages.push(data);
                            }
                        } catch (e) {
                            // Skip invalid lines
                        }
                    }
                }

                currentItem = allItems.find(s => s.sessionId === sessionId);

                // Update header title
                const firstUserMsg = currentMessages.find(m => m.type === 'user');
                let title;
                if (currentItem?.customName) {
                    title = currentItem.customName;
                } else if (currentItem?.title) {
                    title = currentItem.title;
                } else {
                    title = firstUserMsg ?
                        (typeof firstUserMsg.message.content === 'string'
                            ? firstUserMsg.message.content.substring(0, 60)
                            : Array.isArray(firstUserMsg.message.content) && firstUserMsg.message.content[0]?.text
                                ? firstUserMsg.message.content[0].text.substring(0, 60)
                                : 'Conversation') + '...'
                        : 'Conversation';
                }
                document.getElementById('conversationTitle').textContent = title;
                
                // Show Edit Title Button
                document.getElementById('editTitleBtn').style.display = 'flex';

                // Populate Properties
                document.getElementById('propertiesSection').style.display = 'block';
                
                // Project
                const projName = currentItem?.project || 'Unknown project';
                document.getElementById('propProject').innerHTML = `<span style="color:var(--text-primary)">${projName}</span>`;
                
                // Created
                let createdDateStr = '-';
                if (currentItem.firstTimestamp) {
                    createdDateStr = new Date(currentItem.firstTimestamp).toLocaleString('ko-KR');
                } else if (currentItem.modifiedTime) {
                    createdDateStr = new Date(currentItem.modifiedTime * 1000).toLocaleString('ko-KR');
                }
                document.getElementById('propCreated').textContent = createdDateStr;
                
                // Messages
                document.getElementById('propMessages').textContent = currentMessages.length;
                
                // Session ID
                document.getElementById('propSessionId').textContent = sessionId;
                document.getElementById('sessionIdDisplay').textContent = sessionId; // Hidden input for logic
                
                // Tags
                renderPropertyTags(sessionId);
                
                // Description
                renderPropertyDescription(sessionId);

                // Render Conversation
                renderConversation();

                // Show scroll buttons
                document.getElementById('scrollButtons').classList.add('visible');
            } catch (error) {
                console.error('Error loading session:', error);
                document.getElementById('conversationContent').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-title">Failed to load conversation</div>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function showHistoryEntry(historyId, display, timestamp) {
            // Update UI
            document.querySelectorAll('.session-item').forEach(el => {
                el.classList.toggle('active', el.dataset.historyId === historyId);
            });

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('conversationView').style.display = 'flex';

            currentItem = allItems.find(i => i.historyId === historyId);
            currentMessages = [];

            // Create a single user message from history
            if (display) {
                currentMessages.push({
                    type: 'user',
                    timestamp: timestamp,
                    message: { role: 'user', content: display }
                });
            }

            const title = display ? display.substring(0, 60) + (display.length > 60 ? '...' : '') : 'History Entry';
            document.getElementById('conversationTitle').textContent = title;
            document.getElementById('editTitleBtn').style.display = 'none';

            // Hide Properties for History
            document.getElementById('propertiesSection').style.display = 'none';

            renderConversation();

            // Show scroll buttons
            document.getElementById('scrollButtons').classList.add('visible');
        }

        // Render tags in properties section
        function renderPropertyTags(sessionId) {
            const container = document.getElementById('propTags');
            if (!currentItem || currentItem.type !== 'session') return;

            const tags = getSessionTags(sessionId, currentItem.customName);
            const addBtn = document.getElementById('propAddTagBtn');
            
            // Clear existing tags (keep button)
            Array.from(container.querySelectorAll('.pill-tag')).forEach(el => el.remove());
            
            // Insert before button
            tags.forEach(tag => {
                const span = document.createElement('span');
                span.className = `pill-tag ${tag === 'named' ? 'named-tag' : ''}`;
                span.dataset.tag = tag;
                span.innerHTML = `${escapeHtml(tag)} ${tag !== 'named' ? '<span class="remove-tag">&times;</span>' : ''}`;
                
                if (tag !== 'named') {
                    span.querySelector('.remove-tag').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeTagFromSession(sessionId, tag);
                    });
                }
                
                container.insertBefore(span, addBtn);
            });
        }

        // Render description in properties section
        function renderPropertyDescription(sessionId) {
            const row = document.getElementById('propDescRow');
            const container = document.getElementById('propDescription');
            const description = getSessionDescription(sessionId);
            
            if (description) {
                row.style.display = 'flex';
                container.innerHTML = escapeHtml(description).replace(/\n/g, '<br>');
            } else {
                row.style.display = 'none';
                container.innerHTML = '';
            }
        }

        // Override renderHeaderTags and renderHeaderDescription since we moved them
        function renderHeaderTags() { renderPropertyTags(currentItem?.sessionId); }
        function renderHeaderDescription() { renderPropertyDescription(currentItem?.sessionId); }

        // Initialize Property Section Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Toggle Properties
            document.getElementById('propertiesToggle').addEventListener('click', () => {
                document.getElementById('propertiesSection').classList.toggle('collapsed');
            });
            
            // Add Tag Button
            document.getElementById('propAddTagBtn').addEventListener('click', () => {
                if (currentItem) openTagModal(currentItem.sessionId);
            });
            
            // Copy ID Button
            document.getElementById('propCopyId').addEventListener('click', () => {
                if (currentItem) copyToClipboard(currentItem.sessionId, 'propCopyId', '');
            });
            
            // Action Links
            document.getElementById('actResume').addEventListener('click', (e) => {
                e.preventDefault();
                handleResumeAction('default', false);
            });
            document.getElementById('actCopy').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('copyMdBtn').click();
            });
            document.getElementById('actRename').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('renameSessionBtn').click();
            });
            document.getElementById('actDelete').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('deleteSessionBtn').click();
            });
        });

        function renderConversation() {
            const container = document.getElementById('conversationContent');
            console.log('[DEBUG] renderConversation called, container:', container);
            console.log('[DEBUG] currentMessages length:', currentMessages.length);

            let matchCount = 0;
            let html = '';

            currentMessages.forEach((msg, index) => {
                const isUser = msg.type === 'user';
                const role = isUser ? 'User' : (currentAgent === 'opencode' ? 'OpenCode' : 'Claude');

                // Show date+time if not today, time only if today
                let time = '';
                if (msg.timestamp) {
                    const msgDate = new Date(msg.timestamp);
                    const today = new Date();

                    if (msgDate.toDateString() === today.toDateString()) {
                        // Today - show time only
                        time = formatTime(msgDate);
                    } else {
                        // Not today - show date + time
                        time = formatDateTime(msgDate);
                    }
                }
                
                let content = '';
                let hasTextContent = false;  // Track if message has actual text (not just tool calls)
                const msgContent = msg.message?.content;

                if (typeof msgContent === 'string') {
                    content = msgContent;
                    hasTextContent = msgContent.trim().length > 0;
                } else if (Array.isArray(msgContent)) {
                    // Handle array content (tool results, etc.)
                    msgContent.forEach(item => {
                        if (item.type === 'text') {
                            content += item.text + '\n';
                            if (item.text.trim()) hasTextContent = true;
                        } else if (item.type === 'tool_use') {
                            content += `__TOOL_MARKER_START__${item.name}__TOOL_MARKER_END__\n`;
                        } else if (item.type === 'tool_result') {
                            // Skip tool results in display for cleaner view
                        }
                    });
                }

                // Skip empty messages
                if (!content.trim()) {
                    return;
                }

                // Check if matches search
                const contentLower = content.toLowerCase();
                const matches = !conversationSearchQuery || contentLower.includes(conversationSearchQuery);
                if (conversationSearchQuery && matches) matchCount++;

                // Check if markdown rendering is enabled
                const renderMarkdownEnabled = document.getElementById('renderMarkdown')?.checked || false;

                // Process content based on markdown mode
                let displayContent;
                let hasDisplayableContent = true;  // Track if there's content to show after processing
                if (renderMarkdownEnabled) {
                    // Remove tool markers before markdown parsing
                    let cleanContent = content.replace(/__TOOL_MARKER_START__.+?__TOOL_MARKER_END__\n?/g, '').trim();
                    // Check if there's actual content after removing tool markers
                    hasDisplayableContent = cleanContent.length > 0;
                    // Parse markdown (marked.parse handles escaping internally)
                    displayContent = cleanContent ? marked.parse(cleanContent, { breaks: false, gfm: true }) : '';
                    // Convert local file:// paths to API paths for images
                    displayContent = displayContent.replace(
                        /src="file:\/\/([^"]+)"/g,
                        (match, path) => `src="/api/local-file?path=${encodeURIComponent(path)}"`
                    );
                    // Also handle absolute paths starting with /
                    displayContent = displayContent.replace(
                        /src="(\/Users\/[^"]+)"/g,
                        (match, path) => `src="/api/local-file?path=${encodeURIComponent(path)}"`
                    );
                    // Highlight search if needed (after markdown parsing)
                    if (conversationSearchQuery) {
                        displayContent = highlightSearch(displayContent, conversationSearchQuery);
                    }
                } else {
                    // Original raw mode with escaping
                    displayContent = conversationSearchQuery
                        ? highlightSearch(escapeHtml(content), conversationSearchQuery)
                        : escapeHtml(content);

                    // Convert tool markers to HTML (after escaping)
                    displayContent = displayContent.replace(
                        /__TOOL_MARKER_START__(.+?)__TOOL_MARKER_END__/g,
                        '<span class="tool-indicator">[Tool: $1]</span>'
                    );
                }

                // Add tool-only-message class if no text content (only tool calls)
                const toolOnlyClass = !hasTextContent ? 'tool-only-message' : '';
                const markdownClass = renderMarkdownEnabled ? 'markdown-rendered' : '';

                // Store raw content for copy functionality
                const rawContent = content.replace(/__TOOL_MARKER_START__.+?__TOOL_MARKER_END__\n?/g, '').trim();
                const escapedRawContent = rawContent.replace(/`/g, '\\`').replace(/\$/g, '\\$');

                // Determine avatar letter based on agent type
                const avatarLetter = isUser ? 'U' : (currentAgent === 'opencode' ? 'O' : 'C');

                html += `
                    <div class="message ${isUser ? 'user' : 'assistant'} ${toolOnlyClass}" style="${!matches && conversationSearchQuery ? 'opacity: 0.3;' : ''}">
                        <div class="message-header">
                            <div class="message-avatar">${avatarLetter}</div>
                            <span class="message-role">${role}</span>
                            <span class="message-time">${time}</span>
                            <button class="msg-copy-btn" title="Copy message" data-content="${encodeURIComponent(rawContent)}">
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14" height="14">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                            </button>
                        </div>
                        ${hasDisplayableContent ? `<div class="message-content ${markdownClass}">${displayContent}</div>` : ''}
                        ${renderToolUse(msg)}
                    </div>
                `;
            });

            console.log('[DEBUG] html length:', html.length, 'html empty:', !html);
            container.innerHTML = html || '<div class="empty-state"><p>No messages in this conversation</p></div>';
            console.log('[DEBUG] container innerHTML set, container.innerHTML length:', container.innerHTML.length);

            // Update search info
            const searchInfo = document.getElementById('searchResultsInfo');
            if (conversationSearchQuery) {
                searchInfo.textContent = `${matchCount} message${matchCount !== 1 ? 's' : ''} matching "${conversationSearchQuery}"`;
            } else {
                searchInfo.textContent = '';
            }
        }

        function renderToolUse(msg) {
            if (msg.type !== 'assistant') return '';

            const content = msg.message?.content;
            if (!Array.isArray(content)) return '';

            const renderMarkdownEnabled = document.getElementById('renderMarkdown')?.checked || false;

            let html = '';
            content.forEach(item => {
                if (item.type === 'tool_use') {
                    let inputDisplay;

                    if (renderMarkdownEnabled && typeof item.input === 'object') {
                        // Render as formatted key-value pairs
                        inputDisplay = '<div class="tool-params">';
                        for (const [key, value] of Object.entries(item.input)) {
                            const displayValue = typeof value === 'string'
                                ? (value.length > 200 ? value.substring(0, 200) + '...' : value)
                                : JSON.stringify(value);
                            inputDisplay += `
                                <div class="tool-param">
                                    <span class="tool-param-key">${escapeHtml(key)}</span>
                                    <span class="tool-param-value">${escapeHtml(displayValue)}</span>
                                </div>
                            `;
                        }
                        inputDisplay += '</div>';
                    } else {
                        // Raw JSON display
                        const inputStr = typeof item.input === 'string'
                            ? item.input
                            : JSON.stringify(item.input, null, 2);
                        inputDisplay = `<pre class="tool-json">${escapeHtml(inputStr.substring(0, 500))}${inputStr.length > 500 ? '...' : ''}</pre>`;
                    }

                    html += `
                        <div class="tool-use">
                            <div class="tool-use-header">
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <span class="tool-use-name">${item.name}</span>
                                <button class="tool-use-toggle" title="Toggle details">
                                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                            </div>
                            <div class="tool-use-input">${inputDisplay}</div>
                        </div>
                    `;
                }
            });

            return html;
        }

        // Utility functions
        function formatRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHr = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHr / 24);

            if (diffSec < 60) return 'just now';
            if (diffMin < 60) return `${diffMin}m ago`;
            if (diffHr < 24) return `${diffHr}h ago`;
            if (diffDay < 7) return `${diffDay}d ago`;
            
            // For older items, use short date
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatDate(date) {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', { 
                    weekday: 'long',
                    month: 'short', 
                    day: 'numeric',
                    year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
                });
            }
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDateTime(date) {
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            }) + ' ' + date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatShortDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function highlightSearch(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function debounce(fn, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // ========== Rename Modal Functions ==========
        let currentRenameSessionId = null;

        function openRenameModal(sessionId) {
            currentRenameSessionId = sessionId;
            const session = allItems.find(s => s.sessionId === sessionId);
            document.getElementById('renameInput').value = session?.customName || '';
            document.getElementById('descriptionInput').value = getSessionDescription(sessionId);
            document.getElementById('renameModal').classList.add('active');
            setTimeout(() => document.getElementById('renameInput').focus(), 100);
        }

        function closeRenameModal() {
            document.getElementById('renameModal').classList.remove('active');
            currentRenameSessionId = null;
        }

        async function saveRename() {
            if (!currentRenameSessionId) return;

            const name = document.getElementById('renameInput').value.trim();
            const description = document.getElementById('descriptionInput').value.trim();
            const sessionId = currentRenameSessionId;

            try {
                // Save name
                const nameResponse = await fetch('/api/rename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        name: name || null
                    })
                });

                if (!nameResponse.ok) {
                    const error = await nameResponse.json();
                    alert(`  : ${error.detail || '   '}`);
                    return;
                }

                // Save description
                const descResponse = await fetch('/api/description', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        description: description || null
                    })
                });

                if (!descResponse.ok) {
                    const error = await descResponse.json();
                    alert(`  : ${error.detail || '   '}`);
                    return;
                }

                // Update local data - name in allItems, description in sessionDescriptions
                const item = allItems.find(s => s.sessionId === sessionId);
                if (item) {
                    if (name) {
                        item.customName = name;
                    } else {
                        delete item.customName;
                    }
                }

                if (description) {
                    sessionDescriptions[sessionId] = description;
                } else {
                    delete sessionDescriptions[sessionId];
                }

                // Update UI if this is the current session
                if (currentItem && currentItem.sessionId === sessionId) {
                    document.getElementById('conversationTitle').textContent =
                        name || currentItem.preview?.substring(0, 100) || 'Untitled';
                    refreshHeaderTags(sessionId);
                    renderHeaderDescription();
                }

                // Refresh session list
                applyFilters();

                closeRenameModal();
                console.log(`Session renamed: ${sessionId}`);
            } catch (error) {
                alert(` : ${error.message}`);
            }
        }

        function clearRenameFields() {
            document.getElementById('renameInput').value = '';
            document.getElementById('descriptionInput').value = '';
        }

        // Close modal on Escape key and Cmd+Enter to save
        document.addEventListener('keydown', (e) => {
            // Escape closes modals
            if (e.key === 'Escape') {
                if (document.getElementById('renameModal').classList.contains('active')) {
                    closeRenameModal();
                }
                if (document.getElementById('tagModal')?.classList.contains('active')) {
                    closeTagModal();
                }
            }
            // Cmd+Enter or Ctrl+Enter saves rename modal
            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                if (document.getElementById('renameModal').classList.contains('active')) {
                    e.preventDefault();
                    saveRename();
                }
                if (document.getElementById('tagModal')?.classList.contains('active')) {
                    e.preventDefault();
                    saveTag();
                }
            }
        });

        // Tag Modal Functions
        let tagModalSessionId = null;

        function openTagModal(sessionId) {
            tagModalSessionId = sessionId;
            document.getElementById('tagInput').value = '';
            document.getElementById('tagModal').classList.add('active');
            setTimeout(() => document.getElementById('tagInput').focus(), 100);
        }

        function closeTagModal() {
            document.getElementById('tagModal').classList.remove('active');
            tagModalSessionId = null;
        }

        function saveTag() {
            const tagInput = document.getElementById('tagInput').value.trim();
            if (tagInput && tagModalSessionId) {
                addTagToSession(tagModalSessionId, tagInput);
            }
            closeTagModal();
        }

        // Close modal on overlay click
        document.getElementById('renameModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'renameModal') {
                closeRenameModal();
            }
        });

        document.getElementById('tagModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'tagModal') {
                closeTagModal();
            }
        });

        // ========== Dashboard Functions ==========
        let activityChart = null;
        let messagesChart = null;
        let currentView = 'sessions';  // 'sessions' or 'dashboard'

        // View tab switching
        document.getElementById('sessionsTab')?.addEventListener('click', () => switchView('sessions'));
        document.getElementById('dashboardTab')?.addEventListener('click', () => switchView('dashboard'));

        function switchView(view) {
            currentView = view;

            // Update tab states
            document.querySelectorAll('.view-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });

            // Toggle views
            const sessionListEl = document.getElementById('sessionList');
            const conversationViewEl = document.getElementById('conversationView');
            const emptyStateEl = document.getElementById('emptyState');
            const dashboardViewEl = document.getElementById('dashboardView');

            if (view === 'sessions') {
                sessionListEl.style.display = '';
                dashboardViewEl.classList.remove('active');
                if (!currentItem) {
                    emptyStateEl.style.display = '';
                    conversationViewEl.style.display = 'none';
                } else {
                    conversationViewEl.style.display = 'flex';
                }
            } else if (view === 'dashboard') {
                sessionListEl.style.display = 'none';
                conversationViewEl.style.display = 'none';
                emptyStateEl.style.display = 'none';
                dashboardViewEl.classList.add('active');
                // Use requestAnimationFrame to ensure DOM is updated before rendering charts
                requestAnimationFrame(() => {
                    setTimeout(() => renderDashboard(), 100);
                });
            }
        }

        function renderDashboard() {
            // Calculate statistics
            const totalSessions = allItems.filter(i => i.sessionId).length;
            const totalMessages = allItems.reduce((sum, i) => sum + (i.messageCount || 0), 0);
            const uniqueProjects = new Set(allItems.map(i => i.project).filter(Boolean));
            const avgMessages = totalSessions > 0 ? Math.round(totalMessages / totalSessions) : 0;

            // Update stat values
            document.getElementById('dashTotalSessions').textContent = totalSessions.toLocaleString();
            document.getElementById('dashTotalMessages').textContent = totalMessages.toLocaleString();
            document.getElementById('dashTotalProjects').textContent = uniqueProjects.size.toLocaleString();
            document.getElementById('dashAvgMessages').textContent = avgMessages.toLocaleString();

            // Render charts
            renderActivityChart();
            renderMessagesChart();
            renderTopProjects();
        }

        function renderActivityChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');

            // Get last 30 days
            const days = [];
            const counts = [];
            const today = new Date();

            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                // Count sessions for this day (use lastTimestamp or lastActivity)
                const count = allItems.filter(item => {
                    const ts = item.lastTimestamp || item.lastActivity;
                    if (!ts) return false;
                    const itemDate = new Date(ts).toISOString().split('T')[0];
                    return itemDate === dateStr;
                }).length;
                counts.push(count);
            }

            // Destroy existing chart
            if (activityChart) {
                activityChart.destroy();
            }

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            const textColor = isDark ? '#94a3b8' : '#64748b';

            activityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Sessions',
                        data: counts,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                color: textColor
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Force resize after creation
            setTimeout(() => activityChart.resize(), 100);
        }

        function renderMessagesChart() {
            const ctx = document.getElementById('messagesChart').getContext('2d');

            // Calculate message distribution by buckets
            const buckets = {
                '1-10': 0,
                '11-50': 0,
                '51-100': 0,
                '101-200': 0,
                '200+': 0
            };

            allItems.forEach(item => {
                const count = item.messageCount || 0;
                if (count <= 10) buckets['1-10']++;
                else if (count <= 50) buckets['11-50']++;
                else if (count <= 100) buckets['51-100']++;
                else if (count <= 200) buckets['101-200']++;
                else buckets['200+']++;
            });

            // Destroy existing chart
            if (messagesChart) {
                messagesChart.destroy();
            }

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#94a3b8' : '#64748b';

            messagesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(buckets),
                    datasets: [{
                        data: Object.values(buckets),
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.7)',
                            'rgba(59, 130, 246, 0.7)',
                            'rgba(168, 85, 247, 0.7)',
                            'rgba(249, 115, 22, 0.7)',
                            'rgba(239, 68, 68, 0.7)'
                        ],
                        borderColor: [
                            'rgba(34, 197, 94, 1)',
                            'rgba(59, 130, 246, 1)',
                            'rgba(168, 85, 247, 1)',
                            'rgba(249, 115, 22, 1)',
                            'rgba(239, 68, 68, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: textColor,
                                padding: 12
                            }
                        }
                    }
                }
            });

            // Force resize after creation
            setTimeout(() => messagesChart.resize(), 100);
        }

        function renderTopProjects() {
            const container = document.getElementById('topProjectsList');

            // Count sessions per project
            const projectCounts = {};
            allItems.forEach(item => {
                const project = item.project || 'Unknown';
                projectCounts[project] = (projectCounts[project] || 0) + 1;
            });

            // Sort by count and take top 10
            const sortedProjects = Object.entries(projectCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const maxCount = sortedProjects.length > 0 ? sortedProjects[0][1] : 1;

            container.innerHTML = sortedProjects.map(([name, count]) => {
                const displayName = name.length > 30 ? '...' + name.slice(-30) : name;
                const percentage = (count / maxCount) * 100;
                return `
                    <div class="project-item">
                        <div class="project-item-header">
                            <span class="project-item-name" title="${name}">${displayName}</span>
                            <span class="project-item-count">${count} sessions</span>
                        </div>
                        <div class="project-item-bar">
                            <div class="project-item-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            if (sortedProjects.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No projects found</p></div>';
            }
        }
        function refreshHeaderTags(sessionId) { renderPropertyTags(sessionId); }

        // --- NEW ACTION BUTTON HANDLERS ---
        
        // 1. Resume Dropdown Toggle
        document.getElementById('resumeDropdownBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            const menu = document.getElementById('resumeDropdownMenu');
            // Close other dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if (m !== menu) m.classList.remove('show');
            });
            menu.classList.toggle('show');
        });

        // Close dropdowns on outside click
        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        });

        // 2. MD Actions
        document.getElementById('actCopyMd').addEventListener('click', () => {
            const btn = document.getElementById('copyMdBtn');
            if (btn) btn.click();
        });

        document.getElementById('actDownloadMd').addEventListener('click', () => {
            const btn = document.getElementById('saveMdBtn');
            if (btn) btn.click();
        });

        // 3. Rename/Delete
        document.getElementById('actRenameNew').addEventListener('click', () => {
            const btn = document.getElementById('actRename');
            if (btn) btn.click();
        });

        document.getElementById('actDeleteNew').addEventListener('click', () => {
            const btn = document.getElementById('actDelete');
            if (btn) btn.click();
        });

    </script>

    <!-- Quick Search Modal (Cmd+Shift+O) -->
    <div class="quick-search-modal" id="quickSearchModal">
        <div class="quick-search-content">
            <div class="quick-search-input-wrapper">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" class="quick-search-input" id="quickSearchInput" placeholder="Search sessions by name, content, tags..." autocomplete="off">
                <span class="quick-search-shortcut">ESC</span>
            </div>
            <div class="quick-search-results" id="quickSearchResults">
                <div class="quick-search-empty">Type to search sessions...</div>
            </div>
            <div class="quick-search-footer">
                <div class="quick-search-footer-item">
                    <span class="quick-search-footer-key"></span>
                    <span>Navigate</span>
                </div>
                <div class="quick-search-footer-item">
                    <span class="quick-search-footer-key">Enter</span>
                    <span>Open</span>
                </div>
                <div class="quick-search-footer-item">
                    <span class="quick-search-footer-key">ESC</span>
                    <span>Close</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="shortcuts-modal" id="shortcutsModal">
        <div class="shortcuts-modal-content">
            <div class="shortcuts-modal-header">
                <span class="shortcuts-modal-title">Keyboard Shortcuts</span>
                <button class="shortcuts-modal-close" id="shortcutsModalClose">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="shortcuts-section">
                <div class="shortcuts-section-title">Navigation</div>
                <div class="shortcut-row"><span class="shortcut-desc">Toggle left sidebar</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key"></span><span class="shortcut-key"></span></div></div>
                <div class="shortcut-row"><span class="shortcut-desc">Toggle right sidebar</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key"></span><span class="shortcut-key"></span></div></div>
                <div class="shortcut-row"><span class="shortcut-desc">Focus session search</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key">K</span></div></div>
                <div class="shortcut-row"><span class="shortcut-desc">Search in conversation</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key">F</span></div></div>
                <div class="shortcut-row"><span class="shortcut-desc">Previous session</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key"></span></div></div>
                <div class="shortcut-row"><span class="shortcut-desc">Next session</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key"></span></div></div>
            </div>
            <div class="shortcuts-section">
                <div class="shortcuts-section-title">Actions</div>
                <div class="shortcut-row"><span class="shortcut-desc">Resume session</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key">R</span></div></div>
                <div class="shortcut-row"><span class="shortcut-desc">Rename session</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key">E</span></div></div>
                <div class="shortcut-row"><span class="shortcut-desc">Copy as Markdown</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key"></span><span class="shortcut-key">C</span></div></div>
                <div class="shortcut-row"><span class="shortcut-desc">Refresh index</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key"></span><span class="shortcut-key">R</span></div></div>
            </div>
            <div class="shortcuts-section">
                <div class="shortcuts-section-title">View</div>
                <div class="shortcut-row"><span class="shortcut-desc">Sessions view</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key">1</span></div></div>
                <div class="shortcut-row"><span class="shortcut-desc">Dashboard view</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key">2</span></div></div>
                <div class="shortcut-row"><span class="shortcut-desc">Toggle theme</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key"></span><span class="shortcut-key">D</span></div></div>
                <div class="shortcut-row"><span class="shortcut-desc">Quick search</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key"></span><span class="shortcut-key">O</span></div></div>
                <div class="shortcut-row"><span class="shortcut-desc">Show shortcuts</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key">/</span></div></div>
                <div class="shortcut-row"><span class="shortcut-desc">Open settings</span><div class="shortcut-keys"><span class="shortcut-key"></span><span class="shortcut-key">,</span></div></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-modal-content">
            <div class="settings-modal-header">
                <span class="settings-modal-title">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Settings
                </span>
                <button class="settings-modal-close" id="settingsModalClose">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">Resume Session</div>
                <div class="settings-row">
                    <div>
                        <div class="settings-label">Default Terminal</div>
                        <div class="settings-label-desc">Choose which terminal to open for Resume</div>
                    </div>
                    <select class="settings-select" id="settingsDefaultTerminal">
                        <option value="copy">Copy to Clipboard</option>
                        <option value="terminal">Terminal</option>
                        <option value="iterm2">iTerm2</option>
                        <option value="warp">Warp</option>
                    </select>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">Appearance</div>
                <div class="settings-row">
                    <div>
                        <div class="settings-label">Theme</div>
                        <div class="settings-label-desc">Switch between light and dark mode</div>
                    </div>
                    <select class="settings-select" id="settingsTheme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <div class="settings-row">
                    <div>
                        <div class="settings-label">Auto-refresh Interval</div>
                        <div class="settings-label-desc">Check for new sessions automatically</div>
                    </div>
                    <select class="settings-select" id="settingsAutoRefresh">
                        <option value="0">Disabled</option>
                        <option value="30">30 seconds</option>
                        <option value="60">1 minute</option>
                        <option value="300">5 minutes</option>
                    </select>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">Display</div>
                <div class="settings-row">
                    <div>
                        <div class="settings-label">Show Tool Calls by Default</div>
                        <div class="settings-label-desc">Display tool calls in conversations</div>
                    </div>
                    <div class="settings-toggle active" id="settingsShowTools"></div>
                </div>
                <div class="settings-row">
                    <div>
                        <div class="settings-label">Render Markdown by Default</div>
                        <div class="settings-label-desc">Parse markdown in messages</div>
                    </div>
                    <div class="settings-toggle" id="settingsRenderMd"></div>
                </div>
            </div>
            <div class="settings-footer">
                <button class="settings-btn settings-btn-secondary" id="settingsReset">Reset to Defaults</button>
                <button class="settings-btn settings-btn-primary" id="settingsSave">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Rename Session</h3>
                <button class="modal-close" onclick="closeRenameModal()">&times;</button>
            </div>
            <div class="modal-body">
                <label class="modal-label">Custom Name</label>
                <input type="text" class="modal-input" id="renameInput" placeholder="Enter custom name...">
                <label class="modal-label">Description (optional)</label>
                <textarea class="modal-textarea" id="descriptionInput" rows="3" placeholder="Enter description..."></textarea>
                <div class="modal-hint"> Cmd+Enter </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn danger" onclick="clearRenameFields()">Clear</button>
                <button class="modal-btn" onclick="closeRenameModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveRename()">Save</button>
            </div>
        </div>
    </div>

    <!-- Tag Modal -->
    <div class="modal-overlay" id="tagModal">
        <div class="modal">
            <div class="modal-header">
                <h3> Add Tags</h3>
                <button class="modal-close" onclick="closeTagModal()">&times;</button>
            </div>
            <div class="modal-body">
                <label class="modal-label">Tags (   )</label>
                <input type="text" class="modal-input" id="tagInput" placeholder=": AI, LLM, , ">
                <div class="modal-hint"> Cmd+Enter </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeTagModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveTag()">Add Tags</button>
            </div>
        </div>
    </div>
</body>
</html>
